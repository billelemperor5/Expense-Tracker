<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Tracker</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #8b5cf6;
            --accent: #ec4899;
            --bg: #f5f3ff;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --nav-height: 75px;
            --shadow-color: rgba(2, 6, 23, .04);
            --border-color: #e2e8f0;
            --primary-soft: rgba(139, 92, 246, 0.15);
        }

        body.dark {
            --primary: #a78bfa;
            --accent: #f472b6;
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --shadow-color: rgba(2, 6, 23, .35);
            --border-color: rgba(255, 255, 255, 0.1);
            --primary-soft: rgba(167, 139, 250, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        html,
        body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            padding-bottom: 100px;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* --- Splash Screen --- */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease, visibility 0.6s;
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-content {
            text-align: center;
            padding: 20px;
            width: 100%;
            max-width: 500px;
        }

        .splash-logo-container {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
            color: white;
            margin: 0 auto 30px;
            box-shadow: 0 20px 40px var(--primary-soft);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .splash-title {
            font-size: 36px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 12px;
            opacity: 0;
            animation: fadeInUp 0.8s forwards 0.3s;
        }

        .splash-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInUp 0.8s forwards 0.5s;
            line-height: 1.6;
        }

        .splash-btn {
            padding: 16px 40px;
            background: var(--text);
            color: var(--bg);
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0;
            animation: fadeInUp 0.8s forwards 0.7s;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 250px;
        }

        .splash-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        body.dark .splash-btn {
            background: var(--primary);
            color: white;
        }

        /* --- Splash Language Selection --- */
        .splash-lang-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .splash-lang-card {
            background: var(--surface);
            padding: 16px 20px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid transparent;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s forwards;
        }

        .splash-lang-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .splash-lang-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .splash-lang-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .splash-lang-card:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        html[dir="rtl"] .splash-lang-card:hover {
            transform: translateX(-5px);
        }

        .splash-lang-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .splash-lang-flag {
            font-size: 24px;
        }

        .splash-lang-name {
            font-weight: 700;
            font-size: 16px;
        }

        .splash-lang-native {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Animations --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-enter {
            opacity: 0;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .click-effect {
            transform: scale(0.95) !important;
            transition: transform 0.1s !important;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background: var(--surface);
            height: 100vh;
            position: fixed;
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: background 0.4s ease, border-color 0.4s ease, right 0.3s, left 0.3s;
        }

        /* RTL Default */
        html[dir="rtl"] .sidebar {
            right: 0;
            border-left: 1px solid var(--border-color);
        }

        html[dir="rtl"] .main {
            margin-right: 280px;
            margin-left: 0;
        }

        html[dir="rtl"] .logo i {
            margin-left: 10px;
        }

        /* LTR Support (English/French) */
        html[dir="ltr"] .sidebar {
            left: 0;
            border-right: 1px solid var(--border-color);
        }

        html[dir="ltr"] .main {
            margin-left: 280px;
            margin-right: 0;
        }

        html[dir="ltr"] .logo i {
            margin-right: 10px;
        }

        html[dir="ltr"] .nav-link i {
            margin-right: 0;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 50px;
            display: flex;
            align-items: center;
        }

        .nav-list {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        html[dir="rtl"] .nav-link:hover,
        html[dir="rtl"] .nav-link.active {
            background: var(--primary-soft);
            color: var(--primary);
            transform: translateX(-5px);
        }

        html[dir="ltr"] .nav-link:hover,
        html[dir="ltr"] .nav-link.active {
            background: var(--primary-soft);
            color: var(--primary);
            transform: translateX(5px);
        }

        /* --- Main Content --- */
        .main {
            width: calc(100% - 280px);
            padding: 100px 40px 40px 40px;
            transition: margin 0.3s ease, width 0.3s ease;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 40px;
            position: fixed;
            top: 0;
            width: calc(100% - 280px);
            z-index: 50;
            background: rgba(248, 250, 252, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            margin: 0;
            transition: background 0.4s ease, border-color 0.4s ease;
        }

        html[dir="rtl"] .app-header {
            right: 280px;
        }

        html[dir="ltr"] .app-header {
            left: 280px;
        }

        .welcome-card {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            padding: 24px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .welcome-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }

        .welcome-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            z-index: -1;
        }

        .welcome-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #e2e8f0;
            background-image: url('https://ui-avatars.com/api/?name=Hassan+Ali&background=8b5cf6&color=fff');
            background-size: cover;
        }

        .kpis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .kpi {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 16px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .kpi:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .kpi .val {
            font-size: 22px;
            font-weight: 700;
        }

        .kpi .lbl {
            font-size: 13px;
            opacity: 0.9;
            color: white;
        }

        .date-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white !important;
            background: linear-gradient(135deg, var(--primary), var(--accent)) !important;
            margin-bottom: 24px;
            padding: 20px 24px;
            border-radius: 20px;
            box-shadow: 0 10px 25px var(--primary-soft);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .date-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            transform: rotate(30deg);
            pointer-events: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
            box-shadow: 0 4px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px var(--shadow-color);
            border-color: var(--primary);
        }

        .icon-holder {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin-bottom: 4px;
            transition: transform 0.4s;
        }

        .card:hover .icon-holder {
            transform: scale(1.1) rotate(10deg);
        }

        .lbl {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
        }

        .btn {
            border: none;
            background: transparent;
            cursor: pointer;
        }

        .btn.icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .btn.icon-btn:hover {
            background: #f1f5f9;
            color: var(--text);
        }

        /* --- Bottom Nav --- */
        .dock-nav {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            height: 70px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dock-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            text-decoration: none;
            color: #94a3b8;
            transition: all 0.4s;
            border-radius: 20px;
        }

        .dock-item i {
            font-size: 22px;
            z-index: 2;
            transition: 0.4s;
        }

        .dock-item.active {
            width: 70px;
            color: white;
        }

        .dock-item.active i {
            transform: translateY(-4px);
        }

        .dock-item.active::after {
            content: '';
            position: absolute;
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 18px;
            z-index: 1;
            animation: popIn 0.4s;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .fab-btn {
            width: 55px;
            height: 55px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 20px color-mix(in srgb, var(--primary) 40%, transparent);
            transform: translateY(-25px);
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main {
                margin: 0 !important;
                width: 100%;
                padding: 80px 15px 15px 15px;
                /* Reduced padding */
            }

            .app-header {
                margin: 0;
                padding: 12px 15px;
                width: 100%;
                right: 0 !important;
                left: 0 !important;
            }

            .dock-nav {
                display: flex;
            }

            .grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                /* Reduced gap */
            }

            /* Reduce sizes for mobile */
            .welcome-card {
                padding: 20px !important;
            }

            .welcome-card h2 {
                font-size: 20px !important;
            }

            .card {
                padding: 15px !important;
            }

            h3,
            h4 {
                font-size: 16px !important;
            }
        }

        body.dark .app-header {
            background: rgba(15, 23, 42, 0.7);
        }

        body.dark .dock-nav {
            background: rgba(30, 41, 59, 0.85);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .theme-card.active,
        .lang-card.active {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .active-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--primary);
            opacity: 0;
            transition: all 0.3s;
        }

        .theme-card.active .active-indicator,
        .lang-card.active .active-indicator {
            opacity: 1;
        }

        /* --- Developer Modal --- */
        .dev-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dev-modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .dev-modal {
            background: var(--surface);
            width: 90%;
            max-width: 350px;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .dev-modal-overlay.open .dev-modal {
            transform: scale(1);
        }

        .dev-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            border: 4px solid var(--surface);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .dev-info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
            text-align: left;
        }

        html[dir="rtl"] .dev-info-item {
            text-align: right;
        }

        .dev-info-icon {
            width: 35px;
            height: 35px;
            background: var(--surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        /* --- New Professional Details Design --- */
        .details-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 40px var(--shadow-color);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .details-card:hover {
            box-shadow: 0 20px 50px var(--shadow-color);
        }

        .details-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 40px;
            position: relative;
            display: inline-block;
            z-index: 1;
        }

        .details-title::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 10px;
            opacity: 0.2;
        }

        .details-table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 800;
            color: var(--text-muted);
            opacity: 0.8;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .empty-state-container {
            padding: 60px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeInUp 0.5s ease;
        }

        .empty-state-icon {
            font-size: 80px;
            color: #cbd5e1;
            margin-bottom: 25px;
            background: var(--bg);
            width: 120px;
            height: 120px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 300px;
            line-height: 1.6;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 25px;
            width: 100%;
        }

        .legend-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            border-color: var(--border-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .chart-circle-container {
            position: relative;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin: 0 auto;
            background: var(--surface);
            padding: 10px;
        }

        /* --- Timeline Design --- */
        .timeline-container {
            position: relative;
            padding: 10px 0;
            text-align: start;
            /* Reset text align for timeline */
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            position: relative;
            padding-bottom: 30px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-line {
            position: absolute;
            right: 24px;
            /* RTL Default */
            top: 48px;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
            opacity: 0.6;
        }

        html[dir="ltr"] .timeline-line {
            right: auto;
            left: 24px;
        }

        .timeline-item:last-child .timeline-line {
            display: none;
        }

        .timeline-icon-container {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 1;
            background: var(--surface);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px var(--shadow-color);
            flex-shrink: 0;
        }

        .timeline-content-box {
            flex: 1;
            background: var(--bg);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .timeline-item:hover .timeline-content-box {
            border-color: var(--border-color);
            background: var(--surface);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .timeline-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeline-title {
            font-weight: 800;
            font-size: 14px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .timeline-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        body.dark .glass-header {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-val {
            font-size: 20px;
            font-weight: 800;
            margin-top: 5px;
            color: var(--text);
        }

        .stat-lbl {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .calendar-wrapper {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
        }

        .cal-day-header {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .cal-day {
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            font-weight: 600;
            color: var(--text);
        }

        .cal-day:hover {
            background: var(--bg);
        }

        .cal-day.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-soft);
        }

        .cal-day.present {
            background: #dcfce7;
            color: #16a34a;
            font-weight: 800;
        }

        .cal-day.absent {
            background: #fee2e2;
            color: #ef4444;
            font-weight: 800;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn.clear {
            background: #64748b;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }

        .action-btn.absent {
            background: #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .action-btn.present {
            background: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* --- Professional Chart CSS --- */
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 180px;
            padding: 20px 10px 0;
            position: relative;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100%;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .chart-bars-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 6px;
            height: 100%;
        }

        .chart-bar {
            width: 8px;
            border-radius: 4px;
            transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            min-height: 4px;
            /* Ensure visibility even if 0 */
        }

        .chart-bar.absent {
            background: linear-gradient(to top, #ef4444, #fca5a5);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .chart-bar.present {
            background: linear-gradient(to top, #10b981, #6ee7b7);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .chart-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 12px;
            font-weight: 600;
        }

        .chart-value-popup {
            position: absolute;
            top: -25px;
            background: var(--text);
            color: var(--bg);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .chart-bar-group:hover .chart-value-popup {
            opacity: 1;
        }

        .chart-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            border-top: 1px dashed var(--border-color);
            opacity: 0.5;
            z-index: 1;
        }

        /* --- Smart Actions Menu --- */
        .smart-actions-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .smart-actions-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .smart-actions-menu {
            background: var(--surface);
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 30px 20px 40px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .smart-actions-overlay.open .smart-actions-menu {
            transform: translateY(0);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .smart-action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .smart-action-item:active {
            transform: scale(0.95);
        }

        .smart-action-icon {
            width: 55px;
            height: 55px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s;
        }

        .smart-action-item:hover .smart-action-icon {
            transform: translateY(-3px);
        }

        .smart-action-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text);
            text-align: center;
        }
    </style>
</head>

<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <!-- Step 1: Welcome -->
        <div id="splash-step-1" class="splash-content">
            <div class="splash-logo-container">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <div class="splash-title" data-key="appName">Expense Tracker</div>
            <div class="splash-subtitle" data-key="splash_msg">...</div>
            <button class="splash-btn" onclick="handleSplashStart()" data-key="splash_btn">Start</button>
        </div>

        <!-- Step 2: Language Selection -->
        <div id="splash-step-2" class="splash-content" style="display: none;">
            <div class="splash-logo-container" style="width: 60px; height: 60px; font-size: 24px; margin-bottom: 20px;">
                <i class="fa-solid fa-language"></i>
            </div>
            <h2 class="splash-title" style="font-size: 24px; margin-bottom: 10px;" data-key="lang_select_title">
                Select
                Language</h2>
            <p class="splash-subtitle" style="margin-bottom: 30px;" data-key="lang_select_subtitle">Please
                select your
                preferred language</p>

            <div class="splash-lang-grid">
                <div class="splash-lang-card" onclick="selectLanguageAndStart('ar')">
                    <div class="splash-lang-info">
                        <div
                            style="width: 40px; height: 28px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <img src="https://flagcdn.com/w80/dz.png" alt="ar"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <div class="splash-lang-name">العربية</div>
                            <div class="splash-lang-native">Arabic</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-left" style="color: var(--text-muted)"></i>
                </div>
                <div class="splash-lang-card" onclick="selectLanguageAndStart('en')">
                    <div class="splash-lang-info">
                        <div
                            style="width: 40px; height: 28px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <img src="https://flagcdn.com/w80/us.png" alt="en"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <div class="splash-lang-name">English</div>
                            <div class="splash-lang-native">English</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: var(--text-muted)"></i>
                </div>
                <div class="splash-lang-card" onclick="selectLanguageAndStart('fr')">
                    <div class="splash-lang-info">
                        <div
                            style="width: 40px; height: 28px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <img src="https://flagcdn.com/w80/fr.png" alt="fr"
                                style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <div class="splash-lang-name">Français</div>
                            <div class="splash-lang-native">French</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: var(--text-muted)"></i>
                </div>
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="logo"><i class="fa-solid fa-cube"></i> <span id="sidebarLogoText" data-key="appName">Expense
                Tracker</span></div>
        <nav class="nav-list">
            <a href="#" class="nav-link active" data-view="home"><i class="fa-solid fa-house"></i> <span
                    data-key="nav_home"></span></a>
            <a href="#" class="nav-link" data-view="expenses"><i class="fa-solid fa-wallet"></i> <span
                    data-key="nav_wallet"></span></a>
            <a href="#" class="nav-link" data-view="about"><i class="fa-solid fa-address-card"></i> <span
                    data-key="nav_about"></span></a>
            <a href="#" class="nav-link" data-view="settings"><i class="fa-solid fa-gear"></i> <span
                    data-key="nav_settings"></span></a>
        </nav>
    </aside>

    <main class="main">
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="logo" style="margin-bottom: 0; font-size: 20px;"><i class="fa-solid fa-wallet"></i>
                </div>
                <div class="animate-enter" style="animation-delay: 0.1s;">
                    <div style="font-weight: 800; font-size: 18px;" data-key="appName">Expense Tracker</div>
                    <div style="font-size: 13px; color: var(--text-muted);" data-key="subHeader"></div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn icon-btn ghost" onclick="openNotificationsModal()" style="position: relative;">
                    <i class="fas fa-bell"></i>
                    <span id="notificationBadge"
                        style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; font-size: 10px; font-weight: 800; width: 16px; height: 16px; border-radius: 50%; display: none; align-items: center; justify-content: center;"></span>
                </button>
                <button id="themeToggleBtn" class="btn icon-btn ghost"><i class="fas fa-moon"></i></button>
                <button class="btn icon-btn ghost" id="loginBtn" onclick="openAuthModal()"><i
                        class="fas fa-user-circle"></i></button>
            </div>
        </header>

        <div id="mainContent"></div>
    </main>

    <nav class="dock-nav">
        <a href="#" class="dock-item active" data-view="home"><i class="fa-solid fa-house"></i></a>
        <a href="#" class="dock-item" data-view="expenses"><i class="fa-solid fa-wallet"></i></a>
        <div class="fab-btn" onclick="toggleSmartActions()">
            <i class="fa-solid fa-plus"></i>
        </div>
        <a href="#" class="dock-item" data-view="about"><i class="fa-solid fa-address-card"></i></a>
        <a href="#" class="dock-item" data-view="settings"><i class="fa-solid fa-gear"></i></a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlRKAjgau3DKYpiG0_FLb1Qd6u3TV7hpU",
            authDomain: "expense-tracker-3c2bc.firebaseapp.com",
            projectId: "expense-tracker-3c2bc",
            storageBucket: "expense-tracker-3c2bc.firebasestorage.app",
            messagingSenderId: "221040052416",
            appId: "1:221040052416:web:004a6457f6aaa080380525",
            measurementId: "G-VRRJM3Q9Z6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose Auth functions globally
        window.firebaseAuth = {
            register: async (email, password, name) => {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    if (name) {
                        await updateProfile(userCredential.user, { displayName: name });
                    }
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    return { success: false, error: error.code }; // Return code for translation mapping
                }
            },
            login: async (email, password) => {
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    return { success: false, error: error.code };
                }
            },
            logout: async () => {
                try {
                    await signOut(auth);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            initListener: (callback) => {
                onAuthStateChanged(auth, callback);
            },
            backupData: async (data) => {
                const user = auth.currentUser;
                if (!user) return { success: false, error: 'not-authenticated' };
                try {
                    await setDoc(doc(db, "users", user.uid), {
                        backup: JSON.stringify(data),
                        timestamp: new Date().toISOString()
                    });
                    return { success: true, timestamp: new Date().toISOString() };
                } catch (e) {
                    console.error(e);
                    return { success: false, error: e.message };
                }
            },
            restoreData: async () => {
                const user = auth.currentUser;
                if (!user) return { success: false, error: 'not-authenticated' };
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        return { success: true, data: JSON.parse(docSnap.data().backup), timestamp: docSnap.data().timestamp };
                    } else {
                        return { success: false, error: 'no-backup-found' };
                    }
                } catch (e) {
                    console.error(e);
                    return { success: false, error: e.message };
                }
            }
        };

        // Signal that Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        // --- 1. Translations Data ---
        const translations = {
            ar: {
                code: 'ar', dir: 'rtl', name: 'العربية', appName: 'Expense Tracker', subHeader: 'مدير الأموال الذكي',
                splash_msg: 'أدر مصاريفك الشخصية بكل سهولة واحترافية', splash_btn: 'ابدأ الآن',
                lang_select_title: 'اختر اللغة', lang_select_subtitle: 'من فضلك اختر لغتك المفضلة للمتابعة',
                greeting_welcome: 'أهلاً بك',
                welcome_msg: 'هذا هو ملخص حساباتك لهذا الشهر.',
                total_expenses: 'إجمالي المصروفات', monthly_income: 'إجمالي الدخل',
                lbl_remaining_amount: 'المبلغ المتبقي',
                nav_home: 'الرئيسية', nav_wallet: 'المحفظة', nav_reports: 'التقارير', nav_settings: 'الإعدادات', nav_about: 'عن التطبيق',
                card_inbox: 'ادارة المصاريف', card_inbox_desc: 'تتبع وإدارة المصاريف اليومية',
                expenses_title: 'إدارة المصاريف', col_category: 'الفئة', col_budget: 'الميزانية', col_actual: 'الفعلي', col_diff: 'الفرق',
                lbl_total_income: 'إجمالي الدخل', lbl_total_expenses: 'إجمالي المصروفات', lbl_remaining: 'المبلغ المتبقي',
                btn_add_category: 'إضافة فئة', chart_title: 'توزيع المصاريف',
                setup_budget_title: 'إعداد الميزانية', lbl_categories_budgets: 'الفئات والميزانيات',
                btn_add_new: '+ إضافة جديد', btn_save_changes: 'حفظ التغييرات', btn_edit: 'تعديل', btn_cancel: 'إلغاء',
                placeholder_category: 'اسم الفئة', placeholder_budget: 'الميزانية', lbl_details: 'التفاصيل',
                empty_state_msg: 'لم تقم بإضافة أي مصاريف بعد.', empty_state_action: 'اضغط على زر + في الأعلى لإعداد ميزانيتك.',
                recent_activities: 'الأنشطة الأخيرة', view_more: 'عرض المزيد', activity_history: 'سجل النشاطات',
                log_budget_update: 'تحديث الميزانية', log_expense_update: 'تسجيل مصروف', log_expense_diff: 'تعديل مصروف',
                edit_expense_title: 'تعديل المصروف', lbl_expense_details: 'تفاصيل المصروف',
                lbl_previous_actual: 'الفعلي الحالي', lbl_new_actual: 'الفعلي الجديد', lbl_add_amount: 'إضافة مبلغ',
                info_title: 'دليل استخدام إدارة المصاريف',
                info_step1_title: 'إعداد الميزانية', info_step1_desc: 'قم بتحديد دخلك الشهري وتوزيع الميزانية على الفئات المختلفة.',
                info_step2_title: 'تتبع المصاريف', info_step2_desc: 'سجل مصاريفك الفعلية لكل فئة وقارنها بالميزانية المحددة.',
                info_step3_title: 'التحليل والمراقبة', info_step3_desc: 'راقب الرسوم البيانية والمبلغ المتبقي للتحكم في إنفاقك.',
                info_step4_title: 'سجل النشاطات', info_step4_desc: 'تتبع جميع التعديلات والتغييرات التي قمت بها في سجل مفصل.',
                info_step4_title: 'سجل النشاطات', info_step4_desc: 'تتبع جميع التعديلات والتغييرات التي قمت بها في سجل مفصل.',
                lbl_select_month: 'اختر شهراً آخر', delete_period_confirm: 'هل أنت متأكد من حذف سجلات هذا الشهر؟',
                delete_title: 'حذف السجل', btn_delete: 'حذف',
                card_workers: 'بطاقة رقم 2', card_workers_desc: 'إضافة وتعديل العمال',
                card_smart_wallet: 'المحفظة الذكية', card_smart_wallet_desc: 'إدارة المدخرات والسحوبات',
                wallet_title: 'المحفظة الذكية', lbl_current_balance: 'الرصيد الحالي',
                btn_deposit: 'إيداع', btn_withdraw: 'سحب', lbl_transaction_history: 'سجل العمليات',
                lbl_note: 'ملاحظة', lbl_amount: 'المبلغ', msg_confirm_transaction: 'تأكيد العملية',
                log_deposit: 'إيداع', log_withdraw: 'سحب', placeholder_note: 'اكتب ملاحظة...',
                lbl_total_deposits: 'إجمالي الإيداعات', lbl_total_withdrawals: 'إجمالي السحوبات',
                wallet_info_title: 'كيفية استخدام المحفظة الذكية',
                wallet_info_step1_title: 'إيداع الأموال', wallet_info_step1_desc: 'قم بإضافة الأموال إلى محفظتك لادخارها أو تتبع الدخل الإضافي.',
                wallet_info_step2_title: 'سحب الأموال', wallet_info_step2_desc: 'سجل عمليات السحب عند استخدام المدخرات أو إنفاق الأموال.',
                wallet_info_step1_title: 'إيداع الأموال', wallet_info_step1_desc: 'قم بإضافة الأموال إلى محفظتك لادخارها أو تتبع الدخل الإضافي.',
                wallet_info_step2_title: 'سحب الأموال', wallet_info_step2_desc: 'سجل عمليات السحب عند استخدام المدخرات أو إنفاق الأموال.',
                wallet_info_step3_title: 'سجل العمليات', wallet_info_step3_desc: 'تتبع جميع حركات الإيداع والسحب مع التواريخ والملاحظات.',
                today_date: 'تاريخ اليوم', calendar_title: 'التقويم',
                days_short: ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'],
                today_date: 'تاريخ اليوم', calendar_title: 'التقويم',
                days_short: ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'],
                months_long: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
                profile_title: 'الملف الشخصي', net_balance: 'صافي الرصيد',
                financial_health: 'الصحة المالية', budget_used: 'الميزانية المستهلكة', premium_member: 'عضو مميز',
                login_title: 'تسجيل الدخول', signup_title: 'إنشاء حساب',
                email_label: 'البريد الإلكتروني', password_label: 'كلمة المرور', name_label: 'الاسم الكامل',
                btn_login: 'دخول', btn_signup: 'تسجيل',
                toggle_signup: 'ليس لديك حساب؟ أنشئ حساباً', toggle_login: 'لديك حساب بالفعل؟ سجل دخولك',
                toggle_signup: 'ليس لديك حساب؟ أنشئ حساباً', toggle_login: 'لديك حساب بالفعل؟ سجل دخولك',
                card_attendance: 'سجل الحضور', card_attendance_desc: 'متابعة الحضور والغياب',
                card_analysis: 'الذكاء الاصطناعي', card_analysis_desc: 'قريباً في الإصدار القادم',
                // Smart Actions
                smart_actions_title: 'إجراءات سريعة',
                action_record_expense: 'تسجيل مصروف',
                action_deposit: 'إيداع مبلغ',
                action_attendance: 'سجل الحضور',
                action_ai: 'مساعد الذكاء',
                quick_expense_title: 'تسجيل مصروف سريع',
                lbl_category: 'التصنيف',
                no_categories: 'لا توجد تصنيفات',
                btn_save_expense: 'حفظ المصروف',
                // AI Modal
                ai_coming_soon: 'قريباً',
                ai_feature_title: 'ميزة الذكاء الاصطناعي',
                ai_description: 'نحن نعمل على تطوير مساعد ذكي متقدم لمساعدتك في إدارة مصاريفك وتحليل عاداتك المالية.',
                ai_wait_message: 'انتظرونا في الإصدار القادم! 🚀',
                btn_got_it: 'حسناً، فهمت',
                // Notifications
                notifications_title: 'الإشعارات الذكية',
                notif_budget_critical: 'تحذير: اقتربت من حد الميزانية!',
                notif_budget_warning: 'تنبيه: استهلاك الميزانية',
                notif_wallet_low: 'رصيد المحفظة منخفض',
                notif_wallet_high: 'إنجاز رائع! 🎉',
                notif_attendance_absent: 'تنبيه: أيام غياب متعددة',
                notif_attendance_present: 'أداء ممتاز! 👏',
                notif_category_exceed: 'تجاوز في',
                notif_all_good: 'كل شيء على ما يرام! ✨',
                notif_budget_msg: 'لقد استخدمت {percent}% من ميزانيتك الشهرية. حاول تقليل المصروفات.',
                notif_budget_watch: 'لقد استخدمت {percent}% من ميزانيتك. راقب مصروفاتك بعناية.',
                notif_wallet_low_msg: 'رصيدك الحالي {balance}. فكر في إضافة المزيد من المدخرات.',
                notif_wallet_high_msg: 'رصيدك في المحفظة الذكية وصل إلى {balance}. استمر في الادخار!',
                notif_absent_msg: 'لديك {count} أيام غياب هذا الشهر. حاول تحسين معدل حضورك.',
                notif_present_msg: 'لديك {count} يوم حضور هذا الشهر. استمر في الانتظام!',
                notif_exceed_msg: 'لقد تجاوزت ميزانية هذه الفئة بنسبة {percent}%',
                notif_perfect_msg: 'أنت تدير أموالك بشكل ممتاز. استمر في هذا الأداء الرائع!',
                no_notifications: 'لا توجد إشعارات',
                time_now: 'الآن',
                // Attendance
                attendance_days_present: 'أيام الحضور',
                attendance_days_absent: 'أيام الغياب',
                attendance_work_days: 'أيام العمل',
                attendance_btn_present: 'يوم عمل',
                attendance_btn_absent: 'غياب',
                attendance_btn_clear: 'مسح',
                attendance_trend_title: 'توجه الحضور والغياب',
                attendance_legend_present: 'حضور',
                attendance_legend_absent: 'غياب',
                attendance_activities_title: 'أنشطة الشهر',
                attendance_activity_present: 'حضور',
                attendance_activity_absent: 'غياب',
                attendance_activity_recorded: 'تم تسجيل الحالة',
                attendance_view_more: 'عرض المزيد',
                attendance_no_activities: 'لا توجد أنشطة لهذا الشهر',
                attendance_modal_title: 'سجل أنشطة الشهر',
                attendance_info_title: 'كيفية استخدام سجل الحضور',
                attendance_info_step1: 'تسجيل الحضور والغياب',
                attendance_info_step1_desc: 'اضغط على أي يوم في التقويم لتسجيل حضورك أو غيابك. الأزرار الخضراء تمثل الحضور والحمراء تمثل الغياب.',
                attendance_info_step2: 'متابعة الإحصائيات',
                attendance_info_step2_desc: 'تابع إحصائيات حضورك الشهرية من خلال البطاقات في الأعلى والرسم البياني الذي يعرض اتجاه 6 أشهر.',
                attendance_info_step3: 'إعداد مكان العمل',
                attendance_info_step3_desc: 'يمكنك تخصيص اسم مكان عملك وإضافة شعار من خلال زر الإعدادات في الأعلى.',
                attendance_info_step4: 'سجل الأنشطة',
                attendance_info_step4_desc: 'تتم حفظ جميع سجلاتك في سجل النشاط. يمكنك عرض التفاصيل الكاملة من خلال زر "عرض المزيد".',
                quick_expense_category_label: 'التصنيف',
                quick_expense_amount_label: 'المبلغ',
                quick_expense_btn_save: 'حفظ المصروف',
                settings_title: 'الإعدادات', theme_title: 'السمات والألوان', theme_desc: 'تخصيص ألوان التطبيق',
                lang_title: 'اللغة', lang_desc: 'تغيير لغة التطبيق', lang_select_title: 'اختر اللغة',
                currency_title: 'العملة', currency_desc: 'تغيير عملة العرض', currency_select_title: 'اختر العملة',
                expense_dist_title: 'توزيع المصاريف', expense_dist_desc: 'اختر طريقة إعادة تعيين المصاريف',
                dist_mode_monthly: 'وضع شهري', dist_mode_permanent: 'وضع دائم',
                dist_mode_monthly_desc: 'تتغير الحسابات تلقائياً كل شهر', dist_mode_permanent_desc: 'تبقى الحسابات دائمة حتى يتم تغييرها يدوياً',
                btn_reset_period: 'إعادة تعيين الفترة', reset_period_confirm: 'هل أنت متأكد من إعادة تعيين الفترة الحالية؟ سيتم تصفير جميع المصاريف الفعلية.',
                curr_DZD: 'دينار جزائري', curr_USD: 'دولار أمريكي', curr_EUR: 'يورو', curr_SAR: 'ريال سعودي', curr_EGP: 'جنيه مصري',
                theme_lavender: 'خزامى (الافتراضي)', theme_green: 'أخضر', theme_default: 'أخضر', theme_ocean: 'محيط', theme_forest: 'غابة', theme_sunset: 'غروب',
                about_dev_title: 'تم التطوير بواسطة', about_role: 'مطور تطبيقات', about_desc_long: 'تطبيق متكامل لإدارة المصاريف الشخصية ومتابعة الميزانية بدقة واحترافية. يهدف التطبيق إلى تسهيل حياتك المالية.',
                page_construction: 'صفحة قيد الإنشاء', theme_rose: 'وردي', theme_indigo: 'نيلي', theme_mint: 'نعناع',
                page_construction: 'صفحة قيد الإنشاء',
                setup_workspace_title: 'إعداد مساحة العمل',
                setup_workspace_desc: 'قم بإعداد ملفك الشخصي للعمل لبدء تتبع الحضور والغياب بشكل احترافي.',
                setup_logo_optional: 'إضافة شعار (اختياري)',
                setup_workspace_name_label: 'اسم مكان العمل',
                setup_workspace_name_placeholder: 'مثال: شركة التقنية الحديثة',
                btn_save_start: 'حفظ والبدء',
                alert_workspace_name_required: 'الرجاء إدخال اسم مكان العمل',
                // Advanced Settings
                clear_cache_title: 'مسح ذاكرة التخزين المؤقت',
                clear_cache_desc: 'حذف الملفات المؤقتة لتحسين الأداء',
                factory_reset_title: 'إعادة ضبط المصنع',
                factory_reset_desc: 'حذف جميع البيانات والعودة للإعدادات الافتراضية',
                clear_cache_confirm: 'هل أنت متأكد من مسح ذاكرة التخزين المؤقت؟',
                factory_reset_confirm: '⚠️ تحذير: سيتم حذف جميع بياناتك بشكل نهائي!\n\nهذا يشمل:\n• جميع المصاريف والميزانيات\n• سجلات الحضور\n• المحفظة الذكية\n• جميع الإعدادات\n\nهل أنت متأكد تماماً؟',
                cache_cleared: 'تم مسح ذاكرة التخزين المؤقت بنجاح',
                reset_complete: 'تم إعادة ضبط المصنع بنجاح',
                btn_confirm: 'تأكيد',
                btn_cancel_action: 'إلغاء',
                login_success: 'تم تسجيل الدخول بنجاح',
                signup_success: 'تم إنشاء الحساب بنجاح',
                btn_logout: 'تسجيل الخروج',
                logout_confirm: 'هل أنت متأكد من تسجيل الخروج؟',
                welcome_back_msg: 'نحن سعداء بوجودك معنا! نتمنى لك يوماً سعيداً ✨',
                // Backup
                backup_title: 'النسخ الاحتياطي والاستعادة',
                backup_desc: 'حفظ بياناتك بأمان في السحابة',
                btn_backup: 'نسخ احتياطي الآن',
                btn_restore: 'استعادة البيانات',
                last_backup: 'آخر نسخة احتياطية: ',
                never: 'أبداً',
                backup_success: 'تم النسخ الاحتياطي بنجاح',
                restore_success: 'تم استعادة البيانات بنجاح',
                restore_confirm: 'هل أنت متأكد من استعادة البيانات؟.',
                no_backup_found: 'لا توجد نسخة احتياطية محفوظة.',
                login_required_backup: 'يجب تسجيل الدخول لاستخدام النسخ الاحتياطي.',
                backup_upload_desc: 'رفع البيانات المحلية إلى السحابة بأمان',
                backup_download_desc: 'تنزيل البيانات من السحابة',
                data_summary: 'ملخص البيانات',
            },
            en: {
                code: 'en', dir: 'ltr', name: 'English', appName: 'Expense Tracker', subHeader: 'Smart Money Manager',
                splash_msg: 'Manage your personal finances with ease and professionalism', splash_btn: 'Get Started',
                lang_select_title: 'Select Language', lang_select_subtitle: 'Please select your preferred language to continue',
                greeting_welcome: 'Welcome',
                welcome_msg: 'Here is your account summary for this month.',
                total_expenses: 'Total Expenses', monthly_income: 'Total Income',
                lbl_remaining_amount: 'Remaining Amount',
                nav_home: 'Home', nav_wallet: 'Wallet', nav_reports: 'Reports', nav_settings: 'Settings', nav_about: 'About',
                card_inbox: 'Expense Management', card_inbox_desc: 'Track daily expenses',
                expenses_title: 'Expense Management', col_category: 'Category', col_budget: 'Budget', col_actual: 'Actual', col_diff: 'Diff',
                lbl_total_income: 'Total Income', lbl_total_expenses: 'Total Expenses', lbl_remaining: 'Remaining Balance',
                btn_add_category: 'Add Category', chart_title: 'Expense Distribution',
                setup_budget_title: 'Setup Budget', lbl_categories_budgets: 'Categories & Budgets',
                btn_add_new: '+ Add New', btn_save_changes: 'Save Changes', btn_edit: 'Edit', btn_cancel: 'Cancel',
                placeholder_category: 'Category Name', placeholder_budget: 'Budget', lbl_details: 'Details',
                empty_state_msg: 'No expenses setup yet.', empty_state_action: 'Click the + button above to setup your budget.',
                recent_activities: 'Recent Activities', view_more: 'View More', activity_history: 'Activity History',
                log_budget_update: 'Budget Updated', log_expense_update: 'Expense Recorded', log_expense_diff: 'Expense Adjustment',
                edit_expense_title: 'Edit Expense', lbl_expense_details: 'Expense Details',
                lbl_previous_actual: 'Current Actual', lbl_new_actual: 'New Actual', lbl_add_amount: 'Add Amount',
                info_title: 'Expense Management Guide',
                info_step1_title: 'Setup Budget', info_step1_desc: 'Define your monthly income and allocate budget to categories.',
                info_step2_title: 'Track Expenses', info_step2_desc: 'Record actual expenses and compare them with your budget.',
                info_step3_title: 'Analyze & Monitor', info_step3_desc: 'Watch charts and remaining balance to control spending.',
                info_step4_title: 'Activity Log', info_step4_desc: 'Track all modifications and changes in a detailed log.',
                info_step4_title: 'Activity Log', info_step4_desc: 'Track all modifications and changes in a detailed log.',
                lbl_select_month: 'Select another month', delete_period_confirm: 'Are you sure you want to delete this month records?',
                delete_title: 'Delete Record', btn_delete: 'Delete',
                card_workers: 'Card Number 2', card_workers_desc: 'Manage workers',
                card_smart_wallet: 'Smart Wallet', card_smart_wallet_desc: 'Manage savings and withdrawals',
                wallet_title: 'Smart Wallet', lbl_current_balance: 'Current Balance',
                btn_deposit: 'Deposit', btn_withdraw: 'Withdraw', lbl_transaction_history: 'Transaction History',
                lbl_note: 'Note', lbl_amount: 'Amount', msg_confirm_transaction: 'Confirm Transaction',
                log_deposit: 'Deposit', log_withdraw: 'Withdraw', placeholder_note: 'Write a note...',
                lbl_total_deposits: 'Total Deposits', lbl_total_withdrawals: 'Total Withdrawals',
                wallet_info_title: 'How to use Smart Wallet',
                wallet_info_step1_title: 'Deposit Money', wallet_info_step1_desc: 'Add money to your wallet to save it or track extra income.',
                wallet_info_step2_title: 'Withdraw Money', wallet_info_step2_desc: 'Record withdrawals when you spend from your savings.',
                wallet_info_step1_title: 'Deposit Money', wallet_info_step1_desc: 'Add money to your wallet to save it or track extra income.',
                wallet_info_step2_title: 'Withdraw Money', wallet_info_step2_desc: 'Record withdrawals when you spend from your savings.',
                wallet_info_step3_title: 'Transaction History', wallet_info_step3_desc: 'Track all deposit and withdrawal movements with dates and notes.',
                today_date: 'Today\'s Date', calendar_title: 'Calendar',
                days_short: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                today_date: 'Today\'s Date', calendar_title: 'Calendar',
                days_short: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                months_long: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                profile_title: 'Profile Overview', net_balance: 'Net Balance',
                financial_health: 'Financial Health', budget_used: 'Budget Used', premium_member: 'Premium Member',
                login_title: 'Login', signup_title: 'Sign Up',
                email_label: 'Email Address', password_label: 'Password', name_label: 'Full Name',
                btn_login: 'Login', btn_signup: 'Sign Up',
                toggle_signup: 'Don\'t have an account? Sign Up', toggle_login: 'Already have an account? Login',
                toggle_signup: 'Don\'t have an account? Sign Up', toggle_login: 'Already have an account? Login',
                card_attendance: 'Attendance Log', card_attendance_desc: 'Track attendance & absence',
                card_analysis: 'Artificial Intelligence', card_analysis_desc: 'Coming soon in next update',
                // Smart Actions
                smart_actions_title: 'Quick Actions',
                action_record_expense: 'Record Expense',
                action_deposit: 'Deposit Amount',
                action_attendance: 'Attendance Log',
                action_ai: 'AI Assistant',
                // Backup
                backup_title: 'Backup & Restore',
                backup_desc: 'Securely save your data to the cloud',
                btn_backup: 'Backup Now',
                btn_restore: 'Restore Data',
                last_backup: 'Last Backup: ',
                never: 'Never',
                backup_success: 'Backup successful',
                restore_success: 'Data restored and merged successfully',
                restore_confirm: 'Are you sure you want to restore? New data will be merged with your current data.',
                no_backup_found: 'No backup found.',
                login_required_backup: 'You must be logged in to use backup.',
                backup_upload_desc: 'Securely upload local data to cloud',
                backup_download_desc: 'Download and merge cloud data',
                data_summary: 'Data Summary',
                quick_expense_title: 'Quick Expense Record',
                lbl_category: 'Category',
                no_categories: 'No categories available',
                btn_save_expense: 'Save Expense',
                // AI Modal
                ai_coming_soon: 'Coming Soon',
                ai_feature_title: 'AI Feature',
                ai_description: 'We are developing an advanced AI assistant to help you manage expenses and analyze your financial habits.',
                ai_wait_message: 'Stay tuned for the next release! 🚀',
                btn_got_it: 'Got it',
                // Notifications
                notifications_title: 'Smart Notifications',
                notif_budget_critical: 'Warning: Budget Limit Approaching!',
                notif_budget_warning: 'Alert: Budget Consumption',
                notif_wallet_low: 'Wallet Balance Low',
                notif_wallet_high: 'Great Achievement! 🎉',
                notif_attendance_absent: 'Alert: Multiple Absences',
                notif_attendance_present: 'Excellent Performance! 👏',
                notif_category_exceed: 'Exceeded in',
                notif_all_good: 'Everything is fine! ✨',
                notif_budget_msg: 'You have used {percent}% of your monthly budget. Try to reduce expenses.',
                notif_budget_watch: 'You have used {percent}% of your budget. Monitor your expenses carefully.',
                notif_wallet_low_msg: 'Your current balance is {balance}. Consider adding more savings.',
                notif_wallet_high_msg: 'Your smart wallet balance reached {balance}. Keep saving!',
                notif_absent_msg: 'You have {count} absent days this month. Try to improve your attendance.',
                notif_present_msg: 'You have {count} present days this month. Keep it up!',
                notif_exceed_msg: 'You exceeded this category budget by {percent}%',
                notif_perfect_msg: 'You are managing your money excellently. Keep up this great performance!',
                no_notifications: 'No notifications',
                time_now: 'Now',
                // Attendance
                attendance_days_present: 'Present Days',
                attendance_days_absent: 'Absent Days',
                attendance_work_days: 'Work Days',
                attendance_btn_present: 'Work Day',
                attendance_btn_absent: 'Absent',
                attendance_btn_clear: 'Clear',
                attendance_trend_title: 'Attendance & Absence Trend',
                attendance_legend_present: 'Present',
                attendance_legend_absent: 'Absent',
                attendance_activities_title: 'Monthly Activities',
                attendance_activity_present: 'Present',
                attendance_activity_absent: 'Absent',
                attendance_activity_recorded: 'Status recorded',
                attendance_view_more: 'View More',
                attendance_no_activities: 'No activities for this month',
                attendance_modal_title: 'Monthly Activity Log',
                attendance_info_title: 'How to Use Attendance Log',
                attendance_info_step1: 'Record Attendance & Absence',
                attendance_info_step1_desc: 'Click on any day in the calendar to record your attendance or absence. Green buttons represent attendance and red represent absence.',
                attendance_info_step2: 'Track Statistics',
                attendance_info_step2_desc: 'Monitor your monthly attendance statistics through the cards at the top and the chart showing 6-month trends.',
                attendance_info_step3: 'Workplace Setup',
                attendance_info_step3_desc: 'You can customize your workplace name and add a logo through the settings button at the top.',
                attendance_info_step4: 'Activity Log',
                attendance_info_step4_desc: 'All your records are saved in the activity log. You can view full details through the "View More" button.',
                quick_expense_category_label: 'Category',
                quick_expense_amount_label: 'Amount',
                quick_expense_btn_save: 'Save Expense',
                settings_title: 'Settings', theme_title: 'Themes & Colors', theme_desc: 'Customize app colors',
                lang_title: 'Language', lang_desc: 'Change app language', lang_select_title: 'Select Language',
                currency_title: 'Currency', currency_desc: 'Change display currency', currency_select_title: 'Select Currency',
                expense_dist_title: 'Expense Distribution', expense_dist_desc: 'Choose how expenses are reset',
                dist_mode_monthly: 'Monthly Mode', dist_mode_permanent: 'Permanent Mode',
                dist_mode_monthly_desc: 'Resets automatically every month', dist_mode_permanent_desc: 'Remains until manually reset',
                btn_reset_period: 'Reset Period', reset_period_confirm: 'Are you sure you want to reset the current period? All actual expenses will be set to 0.',
                curr_DZD: 'Algerian Dinar', curr_USD: 'US Dollar', curr_EUR: 'Euro', curr_SAR: 'Saudi Riyal', curr_EGP: 'Egyptian Pound',
                theme_lavender: 'Lavender (Default)', theme_green: 'Green', theme_default: 'Green', theme_ocean: 'Ocean', theme_forest: 'Forest', theme_sunset: 'Sunset',
                about_dev_title: 'Developed By', about_role: 'App Developer', about_desc_long: 'A comprehensive application for managing personal expenses and tracking your budget with precision and professionalism.',
                page_construction: 'Page under construction', theme_rose: 'Rose', theme_indigo: 'Indigo', theme_mint: 'Mint',
                page_construction: 'Page under construction',
                setup_workspace_title: 'Workspace Setup',
                setup_workspace_desc: 'Setup your profile to start tracking attendance professionally.',
                setup_logo_optional: 'Add Logo (Optional)',
                setup_workspace_name_label: 'Workspace Name',
                setup_workspace_name_placeholder: 'Ex: Modern Tech Company',
                btn_save_start: 'Save & Start',
                alert_workspace_name_required: 'Please enter workspace name',
                // Advanced Settings
                clear_cache_title: 'Clear Cache',
                clear_cache_desc: 'Delete temporary files to improve performance',
                factory_reset_title: 'Factory Reset',
                factory_reset_desc: 'Delete all data and restore default settings',
                clear_cache_confirm: 'Are you sure you want to clear the cache?',
                factory_reset_confirm: '⚠️ Warning: All your data will be permanently deleted!\n\nThis includes:\n• All expenses and budgets\n• Attendance records\n• Smart Wallet\n• All settings\n\nAre you absolutely sure?',
                cache_cleared: 'Cache cleared successfully',
                reset_complete: 'Factory reset completed successfully',
                btn_confirm: 'Confirm',
                btn_cancel_action: 'Cancel',
                login_success: 'Login Successful',
                signup_success: 'Account Created Successfully',
                btn_logout: 'Logout',
                logout_confirm: 'Are you sure you want to logout?',
                welcome_back_msg: 'We are glad to have you here! Have a great day ✨'
            },
            fr: {
                code: 'fr', dir: 'ltr', name: 'Français', appName: 'Expense Tracker', subHeader: 'Gestionnaire d\'Argent Intelligent',
                splash_msg: 'Gérez vos finances personnelles avec facilité et professionnalisme', splash_btn: 'Commencer',
                lang_select_title: 'Choisir la langue', lang_select_subtitle: 'Veuillez choisir votre langue préférée pour continuer',
                greeting_welcome: 'Bienvenue',
                welcome_msg: 'Voici le résumé de votre compte pour ce mois.',
                total_expenses: 'Dépenses Totales', monthly_income: 'Revenu Mensuel',
                lbl_remaining_amount: 'Montant Restant',
                nav_home: 'Accueil', nav_wallet: 'Portefeuille', nav_reports: 'Rapports', nav_settings: 'Paramètres', nav_about: 'À propos',
                card_inbox: 'Gestion des Dépenses', card_inbox_desc: 'Suivre les dépenses quotidiennes',
                expenses_title: 'Gestion des Dépenses', col_category: 'Catégorie', col_budget: 'Budget', col_actual: 'Réel', col_diff: 'Diff',
                lbl_total_income: 'Revenu Total', lbl_total_expenses: 'Dépenses Totales', lbl_remaining: 'Solde Restant',
                btn_add_category: 'Ajouter Catégorie', chart_title: 'Répartition des Dépenses',
                setup_budget_title: 'Configuration du Budget', lbl_categories_budgets: 'Catégories et Budgets',
                btn_add_new: '+ Ajouter', btn_save_changes: 'Enregistrer', btn_edit: 'Modifier', btn_cancel: 'Annuler',
                placeholder_category: 'Nom de catégorie', placeholder_budget: 'Budget', lbl_details: 'Détails',
                empty_state_msg: 'Aucune dépense configurée.', empty_state_action: 'Cliquez sur le bouton + ci-dessus pour commencer.',
                recent_activities: 'Activités Récentes', view_more: 'Voir Plus', activity_history: 'Historique d\'activité',
                log_budget_update: 'Budget Mis à jour', log_expense_update: 'Dépense Enregistrée', log_expense_diff: 'Ajustement des dépenses',
                edit_expense_title: 'Modifier la dépense', lbl_expense_details: 'Détails de la dépense',
                lbl_previous_actual: 'Réel Précédent', lbl_new_actual: 'Nouveau Réel', lbl_add_amount: 'Ajouter un montant',
                info_title: 'Guide de Gestion des Dépenses',
                info_step1_title: 'Configuration', info_step1_desc: 'Définissez vos revenus et allouez un budget aux catégories.',
                info_step2_title: 'Suivi', info_step2_desc: 'Enregistrez les dépenses réelles et comparez-les au budget.',
                info_step3_title: 'Analyse', info_step3_desc: 'Surveillez les graphiques et le solde restant.',
                info_step4_title: 'Historique', info_step4_desc: 'Suivez toutes les modifications dans un journal détaillé.',
                info_step4_title: 'Historique', info_step4_desc: 'Suivez toutes les modifications dans un journal détaillé.',
                lbl_select_month: 'Choisir un autre mois', delete_period_confirm: 'Êtes-vous sûr de vouloir supprimer les enregistrements de ce mois ?',
                delete_title: 'Supprimer l\'enregistrement', btn_delete: 'Supprimer',
                card_workers: 'Carte Numéro 2', card_workers_desc: 'Gérer les ouvriers',
                card_smart_wallet: 'Portefeuille Intelligent', card_smart_wallet_desc: 'Gérer l\'épargne et les retraits',
                wallet_title: 'Portefeuille Intelligent', lbl_current_balance: 'Solde Actuel',
                btn_deposit: 'Dépôt', btn_withdraw: 'Retrait', lbl_transaction_history: 'Historique des Transactions',
                lbl_note: 'Note', lbl_amount: 'Montant', msg_confirm_transaction: 'Confirmer la Transaction',
                log_deposit: 'Dépôt', log_withdraw: 'Retrait', placeholder_note: 'Écrire une note...',
                lbl_total_deposits: 'Total Dépôts', lbl_total_withdrawals: 'Total Retraits',
                wallet_info_title: 'Comment utiliser le Portefeuille Intelligent',
                wallet_info_step1_title: 'Dépôt d\'argent', wallet_info_step1_desc: 'Ajoutez de l\'argent à votre portefeuille pour l\'épargner.',
                wallet_info_step2_title: 'Retrait d\'argent', wallet_info_step2_desc: 'Enregistrez les retraits lorsque vous dépensez vos économies.',
                wallet_info_step1_title: 'Dépôt d\'argent', wallet_info_step1_desc: 'Ajoutez de l\'argent à votre portefeuille pour l\'épargner.',
                wallet_info_step2_title: 'Retrait d\'argent', wallet_info_step2_desc: 'Enregistrez les retraits lorsque vous dépensez vos économies.',
                wallet_info_step3_title: 'Historique des transactions', wallet_info_step3_desc: 'Suivez tous les mouvements de dépôt et de retrait.',
                today_date: 'Date d\'aujourd\'hui', calendar_title: 'Calendrier',
                days_short: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                today_date: 'Date d\'aujourd\'hui', calendar_title: 'Calendrier',
                days_short: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                months_long: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                profile_title: 'Profil', net_balance: 'Solde Net',
                financial_health: 'Santé Financière', budget_used: 'Budget Utilisé', premium_member: 'Membre Premium',
                login_title: 'Connexion', signup_title: 'S\'inscrire',
                email_label: 'Adresse E-mail', password_label: 'Mot de passe', name_label: 'Nom Complet',
                btn_login: 'Connexion', btn_signup: 'S\'inscrire',
                toggle_signup: 'Pas de compte ? S\'inscrire', toggle_login: 'Vous avez déjà un compte ? Connexion',
                toggle_signup: 'Pas de compte ? S\'inscrire', toggle_login: 'Vous avez déjà un compte ? Connexion',
                card_attendance: 'Registre de Présence', card_attendance_desc: 'Suivi de présence',
                card_analysis: 'Intelligence Artificielle', card_analysis_desc: 'Bientôt disponible',
                // Smart Actions
                smart_actions_title: 'Actions Rapides',
                action_record_expense: 'Enregistrer Dépense',
                action_deposit: 'Dépôt Montant',
                action_attendance: 'Registre Présence',
                action_ai: 'Assistant IA',
                quick_expense_title: 'Enregistrement Rapide',
                lbl_category: 'Catégorie',
                no_categories: 'Aucune catégorie disponible',
                btn_save_expense: 'Enregistrer Dépense',
                // AI Modal
                ai_coming_soon: 'Bientôt Disponible',
                ai_feature_title: 'Fonctionnalité IA',
                ai_description: 'Nous développons un assistant IA avancé pour vous aider à gérer vos dépenses et analyser vos habitudes financières.',
                ai_wait_message: 'Restez à l\'écoute pour la prochaine version! 🚀',
                btn_got_it: 'Compris',
                // Notifications
                notifications_title: 'Notifications Intelligentes',
                notif_budget_critical: 'Attention: Limite de Budget Approchée!',
                notif_budget_warning: 'Alerte: Consommation Budget',
                notif_wallet_low: 'Solde Portefeuille Faible',
                notif_wallet_high: 'Excellente Réalisation! 🎉',
                notif_attendance_absent: 'Alerte: Absences Multiples',
                notif_attendance_present: 'Performance Excellente! 👏',
                notif_category_exceed: 'Dépassement dans',
                notif_all_good: 'Tout va bien! ✨',
                notif_budget_msg: 'Vous avez utilisé {percent}% de votre budget mensuel. Essayez de réduire les dépenses.',
                notif_budget_watch: 'Vous avez utilisé {percent}% de votre budget. Surveillez vos dépenses attentivement.',
                notif_wallet_low_msg: 'Votre solde actuel est {balance}. Pensez à ajouter plus d\'épargne.',
                notif_wallet_high_msg: 'Votre solde portefeuille a atteint {balance}. Continuez à épargner!',
                notif_absent_msg: 'Vous avez {count} jours d\'absence ce mois-ci. Essayez d\'améliorer votre présence.',
                notif_present_msg: 'Vous avez {count} jours de présence ce mois-ci. Continuez!',
                notif_exceed_msg: 'Vous avez dépassé le budget de cette catégorie de {percent}%',
                notif_perfect_msg: 'Vous gérez votre argent excellemment. Continuez cette excellente performance!',
                no_notifications: 'Aucune notification',
                time_now: 'Maintenant',
                // Attendance
                attendance_days_present: 'Jours Présents',
                attendance_days_absent: 'Jours Absents',
                attendance_work_days: 'Jours Travail',
                attendance_btn_present: 'Jour Travail',
                attendance_btn_absent: 'Absent',
                attendance_btn_clear: 'Effacer',
                // Backup
                backup_title: 'Sauvegarde et Restauration',
                backup_desc: 'Sauvegardez vos données en toute sécurité sur le cloud',
                btn_backup: 'Sauvegarder Maintenant',
                btn_restore: 'Restaurer les Données',
                last_backup: 'Dernière sauvegarde: ',
                never: 'Jamais',
                backup_success: 'Sauvegarde réussie',
                restore_success: 'Données restaurées et fusionnées avec succès',
                restore_confirm: 'Êtes-vous sûr de vouloir restaurer? Les nouvelles données seront fusionnées avec vos données actuelles.',
                no_backup_found: 'Aucune sauvegarde trouvée.',
                login_required_backup: 'Vous devez être connecté pour utiliser la sauvegarde.',
                backup_upload_desc: 'Télécharger les données locales vers le cloud',
                backup_download_desc: 'Télécharger et fusionner les données du cloud',
                data_summary: 'Résumé des données',
                attendance_trend_title: 'Tendance Présence & Absence',
                attendance_legend_present: 'Présent',
                attendance_legend_absent: 'Absent',
                attendance_activities_title: 'Activités Mensuelles',
                attendance_activity_present: 'Présent',
                attendance_activity_absent: 'Absent',
                attendance_activity_recorded: 'Statut enregistré',
                attendance_view_more: 'Voir Plus',
                attendance_no_activities: 'Aucune activité pour ce mois',
                attendance_modal_title: 'Journal d\'Activité Mensuel',
                attendance_info_title: 'Comment Utiliser le Registre',
                attendance_info_step1: 'Enregistrer Présence & Absence',
                attendance_info_step1_desc: 'Cliquez sur n\'importe quel jour du calendrier pour enregistrer votre présence ou absence. Les boutons verts représentent la présence et les rouges l\'absence.',
                attendance_info_step2: 'Suivre les Statistiques',
                attendance_info_step2_desc: 'Surveillez vos statistiques mensuelles via les cartes en haut et le graphique montrant les tendances sur 6 mois.',
                attendance_info_step3: 'Configuration Lieu de Travail',
                attendance_info_step3_desc: 'Vous pouvez personnaliser le nom de votre lieu de travail et ajouter un logo via le bouton paramètres en haut.',
                attendance_info_step4: 'Journal d\'Activité',
                attendance_info_step4_desc: 'Tous vos enregistrements sont sauvegardés dans le journal d\'activité. Vous pouvez voir les détails complets via le bouton "Voir Plus".',
                quick_expense_category_label: 'Catégorie',
                quick_expense_amount_label: 'Montant',
                quick_expense_btn_save: 'Enregistrer Dépense',
                settings_title: 'Paramètres', theme_title: 'Thèmes et Couleurs', theme_desc: 'Personnaliser les couleurs',
                lang_title: 'Langue', lang_desc: 'Changer la langue', lang_select_title: 'Choisir la langue',
                currency_title: 'Devise', currency_desc: 'Changer la devise', currency_select_title: 'Choisir la devise',
                expense_dist_title: 'Répartition des Dépenses', expense_dist_desc: 'Choisir le mode de réinitialisation',
                dist_mode_monthly: 'Mode Mensuel', dist_mode_permanent: 'Mode Permanent',
                dist_mode_monthly_desc: 'Se réinitialise automatiquement chaque mois', dist_mode_permanent_desc: 'Reste jusqu\'à réinitialisation manuelle',
                btn_reset_period: 'Réinitialiser la Période', reset_period_confirm: 'Êtes-vous sûr de vouloir réinitialiser la période actuelle ? Toutes les dépenses réelles seront remises à 0.',
                curr_DZD: 'Dinar Algérien', curr_USD: 'Dollar Américain', curr_EUR: 'Euro', curr_SAR: 'Riyal Saoudien', curr_EGP: 'Livre Égyptienne',
                theme_lavender: 'Lavande (Défaut)', theme_green: 'Vert', theme_default: 'Vert', theme_ocean: 'Océan', theme_forest: 'Forêt', theme_sunset: 'Coucher de soleil',
                about_dev_title: 'Développé Par', about_role: 'Développeur d\'applications', about_desc_long: 'Une application complète pour gérer les dépenses personnelles et suivre votre budget avec précision et professionnalisme.',
                page_construction: 'Page en construction', theme_rose: 'Rose', theme_indigo: 'Niلي', theme_mint: 'Menthe',
                page_construction: 'Page en construction',
                setup_workspace_title: 'Configuration Lieu de Travail',
                setup_workspace_desc: 'Configurez votre profil pour commencer le suivi de présence.',
                setup_logo_optional: 'Ajouter Logo (Optionnel)',
                setup_workspace_name_label: 'Nom du Lieu de Travail',
                setup_workspace_name_placeholder: 'Exemple: Tech Corp',
                btn_save_start: 'Enregistrer et Commencer',
                alert_workspace_name_required: 'Veuillez entrer le nom du lieu de travail',
                // Advanced Settings
                clear_cache_title: 'Vider le Cache',
                clear_cache_desc: 'Supprimer les fichiers temporaires pour améliorer les performances',
                factory_reset_title: 'Réinitialisation d\'usine',
                factory_reset_desc: 'Supprimer toutes les données et restaurer les paramètres par défaut',
                clear_cache_confirm: 'Êtes-vous sûr de vouloir vider le cache?',
                factory_reset_confirm: '⚠️ Attention: Toutes vos données seront définitivement supprimées!\n\nCela inclut:\n• Toutes les dépenses et budgets\n• Registres de présence\n• Portefeuille intelligent\n• Tous les paramètres\n\nÊtes-vous absolument sûr?',
                cache_cleared: 'Cache vidé avec succès',
                reset_complete: 'Réinitialisation d\'usine terminée avec succès',
                btn_confirm: 'Confirmer',
                btn_cancel_action: 'Annuler',
                login_success: 'Connexion réussie',
                signup_success: 'Compte créé avec succès',
                btn_logout: 'Déconnexion',
                logout_confirm: 'Êtes-vous sûr de vouloir vous déconnecter?',
                welcome_back_msg: 'Nous sommes ravis de vous avoir ici! Passez une bonne journée ✨'
            }
        };


        // --- 2. App Logic ---
        // Clean up old storage key if exists
        if (localStorage.getItem('app-language')) {
            const oldLang = localStorage.getItem('app-language');
            localStorage.setItem('app-lang', oldLang);
            localStorage.removeItem('app-language');
        }

        let currentLang = localStorage.getItem('app-lang') || 'ar';


        function setLanguage(lang) {
            if (!translations[lang]) return;

            currentLang = lang;
            const t = translations[lang];

            // تحديث الاتجاه واللغة في الـ HTML
            document.documentElement.lang = t.code;
            document.documentElement.dir = t.dir;

            // حفظ في التخزين المحلي
            localStorage.setItem('app-lang', lang);

            // تحديث نصوص القائمة الجانبية (الثابتة)
            const logoText = document.getElementById('sidebarLogoText');
            if (logoText) logoText.innerText = t.appName;

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (t[key]) el.innerText = t[key];
            });

            // إعادة رسم الصفحة الحالية
            renderView(currentView);
        }

        function triggerEntranceAnimations() {
            const elements = document.querySelectorAll('#mainContent .welcome-card, #mainContent .card, #mainContent .details-card, #mainContent .glass-header, #mainContent .timeline-item, #mainContent .legend-item, #mainContent .kpi, #mainContent h3, #mainContent h4, #mainContent .grid > div');
            elements.forEach((el, index) => {
                el.classList.add('animate-enter');
                el.style.animationDelay = `${index * 0.05}s`;
            });
        }

        function activate(element) {
            document.querySelectorAll('.dock-item, .nav-link').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            const view = element.dataset.view;
            const correspondingSidebarLink = document.querySelector(`.sidebar .nav-link[data-view="${view}"]`);
            if (correspondingSidebarLink) correspondingSidebarLink.classList.add('active');
            const correspondingDockItem = document.querySelector(`.dock-nav .dock-item[data-view="${view}"]`);
            if (correspondingDockItem) correspondingDockItem.classList.add('active');
        }

        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIcon = themeToggleBtn.querySelector('i');

        function applyTheme(isDark) {
            document.body.classList.toggle('dark', isDark);
            themeIcon.className = `fas ${isDark ? 'fa-sun' : 'fa-moon'}`;
            themeIcon.style.animation = 'none';
            themeIcon.offsetHeight;
            themeIcon.style.animation = 'fadeInUp 0.3s ease';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
        }

        themeToggleBtn.addEventListener('click', () => {
            const isCurrentlyDark = document.body.classList.contains('dark');
            applyTheme(!isCurrentlyDark);
        });

        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'enabled') {
            applyTheme(true);
        }

        // --- View Rendering Logic ---
        const mainContent = document.getElementById('mainContent');
        let currentView = 'home';

        function getHomeView() {
            const t = translations[currentLang];
            const cur = currencies[currentCurrency];

            const totalExpenses = expenseManagerData.items.reduce((sum, item) => sum + item.actual, 0);
            const remainingAmount = expenseManagerData.totalIncome - totalExpenses;

            return `
            <section class="welcome-card" style="cursor: pointer;" onclick="openWelcomeModal()">
                <div class="welcome-header" style="align-items: center; margin-bottom: 15px;">
                    <div>
                        <h2 id="greeting" style="font-size: 22px; font-weight: 800; margin: 0 0 4px 0; letter-spacing: -0.5px;"></h2>
                        <p style="font-size: 13px; opacity: 0.95; font-weight: 500; margin: 0;">${t.welcome_msg}</p>
                    </div>
                    <div style="
                        width: 55px; 
                        height: 55px; 
                        border-radius: 20px; 
                        background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)); 
                        backdrop-filter: blur(10px); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        border: 1px solid rgba(255,255,255,0.3); 
                        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
                        transform: rotate(-5deg);
                    ">
                        <i class="fas fa-sack-dollar" style="font-size: 26px; color: #fff; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></i>
                    </div>
                </div>
                <div class="kpis">
                    <div class="kpi">
                        <div class="val">${cur.symbol} ${totalExpenses}</div>
                        <div class="lbl">${t.total_expenses}</div>
                    </div>
                    <div class="kpi">
                        <div class="val">${cur.symbol} ${remainingAmount}</div>
                        <div class="lbl">${t.lbl_remaining_amount}</div>
                    </div>
                </div>
            </section>

            <div class="card date-card" style="cursor: pointer; flex-direction: row; text-align: start;" onclick="openCalendarModal()">
                <div style="z-index: 1;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px; font-weight: 500;">${t.today_date}</div>
                    <div id="currentDateText" style="font-weight: 800; font-size: 18px; letter-spacing: 0.5px;"></div>
                </div>
                <div style="background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); z-index: 1; border: 1px solid rgba(255,255,255,0.3);">
                    <i class="far fa-calendar-alt" style="font-size: 20px;"></i>
                </div>
            </div>

            <!-- Calendar Modal -->
            <div id="calendarModal" class="dev-modal-overlay" onclick="if(event.target === this) closeCalendarModal()">
                <div class="dev-modal" style="max-width: 400px; width: 95%; padding: 0; overflow: hidden;">
                    <div style="padding: 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; display: flex; justify-content: space-between; align-items: center;">
                        <h3 id="calendarMonthYear" style="font-weight: 800; margin: 0; font-size: 20px;"></h3>
                        <button onclick="closeCalendarModal()" class="btn icon-btn" style="width: 30px; height: 30px; color: white; background: rgba(255,255,255,0.2);"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px;">
                        <div id="calendarDaysHeader" style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 700; color: var(--text-muted); font-size: 13px; margin-bottom: 10px;"></div>
                        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;"></div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card click-target" data-view="expenses">
                    <div class="icon-holder" style="background:linear-gradient(135deg,#06b6d4,#0284c7)"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <div style="font-weight:900; font-size: 15px;">${t.card_inbox}</div>
                    <div class="lbl">${t.card_inbox_desc}</div>
                </div>
                <div class="card click-target" data-view="smart_wallet">
                    <div class="icon-holder" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)"><i class="fa-solid fa-wallet"></i></div>
                    <div style="font-weight:900; font-size: 15px;">${t.card_smart_wallet}</div>
                    <div class="lbl">${t.card_smart_wallet_desc}</div>
                </div>
                <div class="card click-target" data-view="attendance">
                    <div class="icon-holder" style="background:linear-gradient(135deg,#0ea5e9,#2563eb)"><i class="fa-solid fa-calendar-check"></i></div>
                    <div style="font-weight:900; font-size: 15px;">${t.card_attendance}</div>
                    <div class="lbl">${t.card_attendance_desc}</div>
                </div>
                <div class="card click-target" onclick="openAIModal()">
                    <div class="icon-holder" style="background:linear-gradient(135deg,#8b5cf6,#d946ef)"><i class="fa-solid fa-robot"></i></div>
                    <div style="font-weight:900; font-size: 15px;">${t.card_analysis}</div>
                    <div class="lbl" style="color: var(--primary); font-weight: 700; font-size: 11px;">${t.card_analysis_desc}</div>
                </div>
            </div>
            `;
        }

        function getSettingsView() {
            const t = translations[currentLang];
            const arrowIcon = currentLang === 'ar' ? 'fa-chevron-left' : 'fa-chevron-right';
            return `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
                <h3 style="margin:0; font-weight:800;">${t.settings_title}</h3>
            </div>
            
            <!-- Language Button -->
            <div data-view="languages" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#3b82f6,#2563eb); font-size: 20px; margin-bottom: 0;"><i class="fas fa-globe"></i></div>
                    <div>
                        <div style="font-weight:700;">${t.lang_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.lang_desc}</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:12px; font-weight:600; color:var(--primary)">${translations[currentLang].name}</span>
                    <i class="fas ${arrowIcon}" style="color: var(--text-muted);"></i>
                </div>
            </div>

            <!-- Themes Button -->
            <div data-view="themes" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#ec4899,#d946ef); font-size: 20px; margin-bottom: 0;"><i class="fas fa-palette"></i></div>
                    <div>
                        <div style="font-weight:700;">${t.theme_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.theme_desc}</div>
                    </div>
                </div>
                <i class="fas ${arrowIcon}" style="color: var(--text-muted);"></i>
            </div>

            <!-- Currency Button -->
            <div data-view="currencies" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#10b981,#059669); font-size: 20px; margin-bottom: 0;"><i class="fas fa-coins"></i></div>
                    <div>
                        <div style="font-weight:700;">${t.currency_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.currency_desc}</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:12px; font-weight:600; color:var(--primary)">${currencies[currentCurrency].symbol}</span>
                    <i class="fas ${arrowIcon}" style="color: var(--text-muted);"></i>
                </div>
            </div>

            <!-- Expense Distribution Button -->
            <div data-view="expense_dist" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#f97316,#ea580c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-chart-pie"></i></div>
                    <div>
                        <div style="font-weight:700;">${t.expense_dist_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.expense_dist_desc}</div>
                    </div>
                </div>
                <i class="fas ${arrowIcon}" style="color: var(--text-muted);"></i>
            </div>

            <!-- Backup Button (New) -->
            <div data-view="backup" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#6366f1,#4f46e5); font-size: 20px; margin-bottom: 0;"><i class="fas fa-cloud"></i></div>
                    <div>
                        <div style="font-weight:700;">${t.backup_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.backup_desc}</div>
                    </div>
                </div>
                <i class="fas ${arrowIcon}" style="color: var(--text-muted);"></i>
            </div>

            <!-- Divider -->
            <div style="height: 1px; background: var(--border-color); margin: 24px 0;"></div>
            <h4 style="font-size: 13px; font-weight: 700; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">⚙️ ${currentLang === 'ar' ? 'إعدادات متقدمة' : currentLang === 'fr' ? 'Paramètres Avancés' : 'Advanced Settings'}</h4>

            <!-- Clear Cache Button -->
            <div onclick="clearAppCache()" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer; border: 1px solid #f59e0b20;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#f59e0b,#d97706); font-size: 20px; margin-bottom: 0;"><i class="fas fa-broom"></i></div>
                    <div>
                        <div style="font-weight:700; color: #f59e0b;">${t.clear_cache_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.clear_cache_desc}</div>
                    </div>
                </div>
                <i class="fas fa-trash-alt" style="color: #f59e0b;"></i>
            </div>

            <!-- Factory Reset Button -->
            <div onclick="factoryReset()" class="card click-target" style="flex-direction: row; align-items: center; justify-content: space-between; text-align: inherit; padding: 12px 16px; margin-bottom: 12px; cursor:pointer; border: 1px solid #ef444420; background: linear-gradient(135deg, #fef2f2, var(--surface));">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon-holder" style="width:48px; height:48px; background: linear-gradient(135deg,#ef4444,#dc2626); font-size: 20px; margin-bottom: 0;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div style="font-weight:700; color: #ef4444;">${t.factory_reset_title}</div>
                        <div style="font-size:13px; color: var(--text-muted);">${t.factory_reset_desc}</div>
                    </div>
                </div>
                <i class="fas fa-power-off" style="color: #ef4444;"></i>
            </div>
            `;
        }

        function getBackupView() {
            const t = translations[currentLang];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';
            let lastBackup = localStorage.getItem('last_backup_date') || t.never;

            // Initial placeholder values
            let expenseCount = '...';
            let walletCount = '...';
            let attendanceCount = '...';

            // Load cloud data asynchronously
            setTimeout(async () => {
                if (localStorage.getItem('user_email')) {
                    const result = await window.firebaseAuth.restoreData();
                    if (result.success && result.data) {
                        const cloudData = result.data;

                        // Update counts from cloud data
                        // حساب عدد جميع العناصر من جميع الفترات
                        let cloudExpenseCount = 0;
                        if (cloudData.allExpensePeriods) {
                            Object.keys(cloudData.allExpensePeriods).forEach(periodId => {
                                if (cloudData.allExpensePeriods[periodId].items) {
                                    cloudExpenseCount += cloudData.allExpensePeriods[periodId].items.length;
                                }
                            });
                        } else if (cloudData.expenseManagerData && cloudData.expenseManagerData.items) {
                            // للتوافق مع النسخ القديمة
                            cloudExpenseCount = cloudData.expenseManagerData.items.length;
                        }

                        const cloudWalletCount = (cloudData.smartWalletData && cloudData.smartWalletData.transactions) ? cloudData.smartWalletData.transactions.length : 0;
                        const cloudAttendanceCount = (cloudData.attendanceData && cloudData.attendanceData.records) ? Object.keys(cloudData.attendanceData.records).length : 0;

                        // Update UI
                        const expenseEl = document.getElementById('cloudExpenseCount');
                        const walletEl = document.getElementById('cloudWalletCount');
                        const attendanceEl = document.getElementById('cloudAttendanceCount');

                        if (expenseEl) expenseEl.textContent = cloudExpenseCount;
                        if (walletEl) walletEl.textContent = cloudWalletCount;
                        if (attendanceEl) attendanceEl.textContent = cloudAttendanceCount;

                        // Update last backup date from cloud
                        if (result.timestamp) {
                            const cloudDate = new Date(result.timestamp).toLocaleString(currentLang);
                            localStorage.setItem('last_backup_date', cloudDate);
                            const dateEl = document.getElementById('lastBackupDatePage');
                            if (dateEl) dateEl.textContent = cloudDate;
                        }
                    } else {
                        // No backup found, show 0
                        const expenseEl = document.getElementById('cloudExpenseCount');
                        const walletEl = document.getElementById('cloudWalletCount');
                        const attendanceEl = document.getElementById('cloudAttendanceCount');

                        if (expenseEl) expenseEl.textContent = '0';
                        if (walletEl) walletEl.textContent = '0';
                        if (attendanceEl) attendanceEl.textContent = '0';
                    }
                } else {
                    // Not logged in
                    const expenseEl = document.getElementById('cloudExpenseCount');
                    const walletEl = document.getElementById('cloudWalletCount');
                    const attendanceEl = document.getElementById('cloudAttendanceCount');

                    if (expenseEl) expenseEl.textContent = '-';
                    if (walletEl) walletEl.textContent = '-';
                    if (attendanceEl) attendanceEl.textContent = '-';
                }
            }, 100);

            return `
                <div style="display:flex; align-items:center; margin-bottom: 24px; gap: 12px;">
                    <button data-view="settings" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800;">${t.backup_title}</h3>
                </div>

                <div style="text-align: center; margin-bottom: 30px; padding: 40px 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 24px; color: white; box-shadow: 0 10px 30px var(--primary-soft);">
                    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; backdrop-filter: blur(10px);">
                        <i class="fas fa-cloud" style="font-size: 40px; color: white;"></i>
                    </div>
                    <h2 style="margin: 0 0 10px 0; font-weight: 800; font-size: 18px;">${t.backup_desc}</h2>
                    <div style="font-size: 13px; opacity: 0.9; background: rgba(0,0,0,0.1); display: inline-block; padding: 6px 16px; border-radius: 20px;">
                        <i class="fas fa-history" style="margin-right: 5px;"></i> ${t.last_backup} <span id="lastBackupDatePage" style="font-weight: 700;">${lastBackup}</span>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <!-- Backup Action -->
                    <div onclick="handleBackup(event)" class="card click-target" style="text-align: center; padding: 24px 16px; border: 2px solid transparent; transition: all 0.3s; cursor: pointer;">
                        <div class="icon-holder" style="width: 50px; height: 50px; background: var(--primary-soft); color: var(--primary); font-size: 22px; margin: 0 auto 15px;"><i class="fas fa-cloud-upload-alt"></i></div>
                        <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 8px;">${t.btn_backup}</h3>
                        <p style="font-size: 11px; color: var(--text-muted); margin: 0;">${t.backup_upload_desc}</p>
                    </div>

                    <!-- Restore Action -->
                    <div onclick="handleRestore(event)" class="card click-target" style="text-align: center; padding: 24px 16px; border: 2px solid transparent; transition: all 0.3s; cursor: pointer;">
                        <div class="icon-holder" style="width: 50px; height: 50px; background: #ecfdf5; color: #10b981; font-size: 22px; margin: 0 auto 15px;"><i class="fas fa-cloud-download-alt"></i></div>
                        <h3 style="font-size: 15px; font-weight: 700; margin-bottom: 8px;">${t.btn_restore}</h3>
                        <p style="font-size: 11px; color: var(--text-muted); margin: 0;">${t.backup_download_desc}</p>
                    </div>
                </div>

                <div style="padding: 20px; background: var(--surface); border-radius: 16px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cloud" style="color: var(--primary);"></i> ${t.data_summary}
                    </h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">
                        <span style="display: flex; align-items: center; gap: 8px;"><i class="fas fa-receipt" style="width: 20px; color: var(--primary);"></i> ${t.card_inbox}</span>
                        <span id="cloudExpenseCount" style="font-weight: 700; color: var(--text);">${expenseCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">
                        <span style="display: flex; align-items: center; gap: 8px;"><i class="fas fa-wallet" style="width: 20px; color: #10b981;"></i> ${t.wallet_title}</span>
                        <span id="cloudWalletCount" style="font-weight: 700; color: var(--text);">${walletCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted);">
                        <span style="display: flex; align-items: center; gap: 8px;"><i class="fas fa-calendar-check" style="width: 20px; color: #3b82f6;"></i> ${t.card_attendance}</span>
                        <span id="cloudAttendanceCount" style="font-weight: 700; color: var(--text);">${attendanceCount}</span>
                    </div>
                </div>
            `;
        }

        function getThemesView() {
            const t = translations[currentLang];
            const lightThemes = Object.keys(themes).filter(key => themes[key].type === 'light');
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';

            const createThemeCards = (themeKeys) => themeKeys.map(themeKey => {
                const theme = themes[themeKey];
                const isActive = themeKey === currentTheme;
                const themeName = t[`theme_${themeKey.split('-')[0]}`] || theme.name;

                return `
                    <div class="card theme-card click-target ${isActive ? 'active' : ''}" data-theme="${themeKey}" style="padding: 12px; position: relative;">
                        <div style="display: flex; gap: 8px; width: 100%; height: 40px; margin-bottom: 8px;">
                            <div style="flex: 1; background-color: ${theme.colors['--bg']}; border-radius: 4px; border:1px solid #eee"></div>
                            <div style="flex: 2; background-color: ${theme.colors['--surface']}; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 4px; border:1px solid #eee">
                                <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${theme.colors['--primary']};"></div>
                                <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${theme.colors['--accent']};"></div>
                            </div>
                        </div>
                        <div style="font-weight: 700; font-size: 12px;">${themeName}</div>
                        <div class="active-indicator"><i class="fas fa-check-circle"></i></div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display:flex; align-items:center; margin-bottom: 16px; gap: 12px;">
                    <button data-view="settings" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800;">${t.theme_title}</h3>
                </div>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-top: 20px;">
                    ${createThemeCards(lightThemes)}
                </div>
            `;
        }

        function getLanguagesView() {
            const t = translations[currentLang];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';

            const langs = ['ar', 'en', 'fr'];

            const langCards = langs.map(code => {
                const langData = translations[code];
                const isActive = code === currentLang;
                let flagCode = 'us';
                if (code === 'ar') flagCode = 'dz';
                if (code === 'fr') flagCode = 'fr';

                return `
                    <div class="card lang-card click-target ${isActive ? 'active' : ''}" data-lang-code="${code}" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 16px; margin-bottom: 10px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 28px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <img src="https://flagcdn.com/w80/${flagCode}.png" alt="${code}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div style="font-weight: 700; font-size: 16px;">${langData.name}</div>
                        </div>
                        <div class="active-indicator" style="position:static; opacity: ${isActive ? 1 : 0}"><i class="fas fa-check-circle"></i></div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display:flex; align-items:center; margin-bottom: 16px; gap: 12px;">
                    <button data-view="settings" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800;">${t.lang_select_title}</h3>
                </div>
                <div style="display:flex; flex-direction:column; gap: 8px;">
                    ${langCards}
                </div>
            `;
        }

        function getCurrenciesView() {
            const t = translations[currentLang];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';

            const currencyCards = Object.keys(currencies).map(code => {
                const curr = currencies[code];
                const isActive = code === currentCurrency;
                const name = t[`curr_${code}`];
                return `
                    <div class="card currency-card click-target ${isActive ? 'active' : ''}" data-currency-code="${code}" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 16px; margin-bottom: 12px; cursor: pointer; border: 1px solid transparent; transition: all 0.3s ease;">
                        <div style="display:flex; align-items:center; gap: 16px;">
                            <div style="width: 48px; height: 32px; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <img src="https://flagcdn.com/w80/${curr.countryCode}.png" alt="${code}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div>
                                <div style="font-weight: 700; font-size: 15px;">${name}</div>
                                <div style="font-size: 12px; color: var(--text-muted); font-weight: 500;">${code} • ${curr.symbol}</div>
                            </div>
                        </div>
                        <div class="active-indicator" style="position:static; opacity: ${isActive ? 1 : 0}; color: var(--primary); font-size: 18px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display:flex; align-items:center; margin-bottom: 24px; gap: 12px;">
                    <button data-view="settings" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800; font-size: 20px;">${t.currency_select_title}</h3>
                </div>
                <div style="display:flex; flex-direction:column; gap: 4px;">
                    ${currencyCards}
                </div>
            `;
        }

        function getExpenseDistView() {
            const t = translations[currentLang];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';
            const currentMode = localStorage.getItem('expense_distribution_mode') || 'monthly';

            const modes = [
                { id: 'monthly', title: t.dist_mode_monthly, desc: t.dist_mode_monthly_desc, icon: 'fa-calendar-alt', color: '#3b82f6' },
                { id: 'permanent', title: t.dist_mode_permanent, desc: t.dist_mode_permanent_desc, icon: 'fa-infinity', color: '#8b5cf6' }
            ];

            const modeCards = modes.map(mode => {
                const isActive = mode.id === currentMode;
                return `
                    <div class="card click-target ${isActive ? 'active' : ''}" onclick="setExpenseDistMode('${mode.id}')" style="flex-direction: row; align-items: center; justify-content: space-between; padding: 16px; margin-bottom: 12px; cursor: pointer; border: 1px solid transparent;">
                        <div style="display:flex; align-items:center; gap: 16px;">
                            <div style="width: 48px; height: 48px; border-radius: 12px; background: ${mode.color}15; color: ${mode.color}; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                <i class="fas ${mode.icon}"></i>
                            </div>
                            <div style="text-align: start;">
                                <div style="font-weight: 700; font-size: 15px;">${mode.title}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${mode.desc}</div>
                            </div>
                        </div>
                        <div class="active-indicator" style="position:static; opacity: ${isActive ? 1 : 0}; color: var(--primary); font-size: 18px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display:flex; align-items:center; margin-bottom: 24px; gap: 12px;">
                    <button data-view="settings" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800; font-size: 20px;">${t.expense_dist_title}</h3>
                </div>
                <div style="display:flex; flex-direction:column; gap: 4px;">
                    ${modeCards}
                </div>
            `;
        }

        function setExpenseDistMode(mode) {
            localStorage.setItem('expense_distribution_mode', mode);
            currentPeriodId = getCurrentMonthId();
            expenseManagerData = getPeriodData(currentPeriodId);
            renderView('expense_dist');
        }

        function getAboutView() {
            const t = translations[currentLang];
            return `
            <div id="about-view-container" style="transition: opacity 0.8s ease; opacity: 1;">
                <div class="card" style="text-align: center; padding: 40px 20px; margin-bottom: 20px;">
                    <div class="splash-logo-container" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 20px; animation: none; box-shadow: 0 10px 25px var(--primary-soft);">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <h2 style="font-weight: 800; margin-bottom: 8px;">${t.appName}</h2>
                    <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">Version 1.0.0</div>
                    
                    <div onclick="showDevModal()" class="click-target" style="background: var(--bg); padding: 20px; border-radius: 16px; margin-bottom: 24px; cursor: pointer; transition: transform 0.2s;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${t.about_dev_title}</div>
                        <div style="font-weight: 700; font-size: 20px; color: var(--primary);">Billel Bouraba</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${t.about_role}</div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;"><i class="fas fa-hand-pointer"></i> Click for info</div>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 16px;">
                        <a href="mailto:billel.dadi123@gmail.com" target="_blank" class="btn icon-btn" style="background: #ea4335; color: white; width: 45px; height: 45px; font-size: 20px;"><i class="fa-solid fa-envelope"></i></a>
                        <a href="https://www.facebook.com/billel.bouraba/" target="_blank" class="btn icon-btn" style="background: #1877f2; color: white; width: 45px; height: 45px; font-size: 20px;"><i class="fa-brands fa-facebook-f"></i></a>
                        <a href="https://www.instagram.com/billel_bouraba/" target="_blank" class="btn icon-btn" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; width: 45px; height: 45px; font-size: 20px;"><i class="fa-brands fa-instagram"></i></a>
                    </div>
                </div>
                
                <div class="card" style="padding: 24px;">
                    <h4 style="margin-bottom: 15px; font-weight: 700; display:flex; align-items:center; gap:10px"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i> ${t.nav_about}</h4>
                    <p style="font-size: 15px; line-height: 1.7; color: var(--text-muted); margin: 0;">
                        ${t.about_desc_long}
                    </p>
                </div>
                
                <div style="text-align:center; margin-top: 30px; color: var(--text-muted); font-size: 12px;">
                    &copy; 2025 ${t.appName}. All rights reserved.
                </div>
            </div>

            <!-- Developer Details Modal -->
            <div id="devModal" class="dev-modal-overlay" onclick="if(event.target === this) hideDevModal()">
                <div class="dev-modal">
                    <button onclick="hideDevModal()" class="btn icon-btn" style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    <div class="dev-avatar-large" style="background: transparent; border: 4px solid var(--primary); padding: 0; overflow: hidden;">
                        <img src="images/billel.png" alt="Billel Bouraba" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h3 style="font-weight: 800; margin-bottom: 5px;">Billel Bouraba</h3>
                    <p style="color: var(--primary); font-weight: 600; font-size: 14px; margin-bottom: 25px;">Full Stack Developer</p>
                    
                    <div class="dev-info-item">
                        <div class="dev-info-icon"><i class="fas fa-envelope"></i></div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">Email</div>
                            <a href="mailto:billel.dadi123@gmail.com" style="font-weight: 600; font-size: 14px; color: var(--text); text-decoration: none;">billel.dadi123@gmail.com</a>
                        </div>
                    </div>
                    <div class="dev-info-item">
                        <div class="dev-info-icon"><i class="fab fa-facebook"></i></div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">Facebook</div>
                            <a href="https://www.facebook.com/billel.bouraba/" target="_blank" style="font-weight: 600; font-size: 14px; color: var(--text); text-decoration: none;">@billel.bouraba</a>
                        </div>
                    </div>
                    <div class="dev-info-item">
                        <div class="dev-info-icon"><i class="fab fa-instagram"></i></div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">Instagram</div>
                            <a href="https://www.instagram.com/billel_bouraba/" target="_blank" style="font-weight: 600; font-size: 14px; color: var(--text); text-decoration: none;">@billel_bouraba</a>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function showDevModal() {
            const modal = document.getElementById('devModal');
            modal.style.display = 'flex';
            // Force reflow
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function hideDevModal() {
            const modal = document.getElementById('devModal');
            modal.classList.remove('open');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // --- Calendar Logic ---
        function openCalendarModal() {
            const modal = document.getElementById('calendarModal');
            const header = document.getElementById('calendarDaysHeader');
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarMonthYear');
            const t = translations[currentLang];

            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = date.getDate();

            title.innerText = `${t.months_long[month]} ${year}`;

            // Render Days Header
            header.innerHTML = t.days_short.map(day => `<div>${day}</div>`).join('');

            // Calculate Grid
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Adjust for RTL/LTR start day if needed (assuming standard Sun-Sat for now, but could be locale specific)
            // For simplicity, we'll stick to standard JS getDay() (0=Sun, 6=Sat) and map to t.days_short order.

            let html = '';

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            // Days
            for (let i = 1; i <= daysInMonth; i++) {
                const isToday = i === today;
                const style = isToday ?
                    'background: var(--primary); color: white; font-weight: 800; box-shadow: 0 4px 10px var(--primary-soft);' :
                    'color: var(--text); background: var(--bg);';

                html += `<div style="height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 14px; cursor: pointer; transition: 0.2s; ${style}" class="calendar-day">${i}</div>`;
            }

            grid.innerHTML = html;

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeCalendarModal() {
            const modal = document.getElementById('calendarModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // --- Welcome Modal Logic ---
        function openWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const netBalanceEl = document.getElementById('modalNetBalance');
            const percentEl = document.getElementById('modalBudgetPercent');
            const barEl = document.getElementById('modalProgressBar');
            const incomeEl = document.getElementById('modalTotalIncome');
            const expensesEl = document.getElementById('modalTotalExpenses');
            const cur = currencies[currentCurrency];

            // Update User Info
            const userName = localStorage.getItem('user_name') || 'User';
            const userPhoto = localStorage.getItem('user_photo');

            const nameEl = document.getElementById('welcomeModalName');
            const imgEl = document.getElementById('welcomeModalImg');

            if (nameEl) nameEl.innerText = userName;

            if (imgEl) {
                if (userPhoto) {
                    imgEl.src = userPhoto;
                } else {
                    imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&size=128&t=${new Date().getTime()}`;
                }
            }

            const totalIncome = expenseManagerData.totalIncome;
            const totalExpenses = expenseManagerData.items.reduce((sum, item) => sum + item.actual, 0);
            const netBalance = totalIncome - totalExpenses;
            const percent = totalIncome > 0 ? Math.min((totalExpenses / totalIncome) * 100, 100) : 0;

            netBalanceEl.innerText = `${cur.symbol} ${netBalance}`;
            netBalanceEl.style.color = netBalance >= 0 ? 'var(--primary)' : '#ef4444';

            percentEl.innerText = `${percent.toFixed(1)}%`;
            barEl.style.width = `${percent}%`;
            barEl.style.backgroundColor = percent > 90 ? '#ef4444' : 'var(--primary)';

            if (incomeEl) incomeEl.innerText = `${cur.symbol} ${totalIncome}`;
            if (expensesEl) expensesEl.innerText = `${cur.symbol} ${totalExpenses}`;

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // --- Auth Modal Logic ---
        let isLoginMode = true;

        function openAuthModal() {
            const modal = document.getElementById('authModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
            isLoginMode = true;
            updateAuthUI();
        }

        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            updateAuthUI();
        }

        function updateAuthUI() {
            const t = translations[currentLang];
            const title = document.getElementById('authTitle');
            const nameField = document.getElementById('nameField');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleBtn = document.getElementById('authToggleBtn');

            if (isLoginMode) {
                title.innerText = t.login_title;
                nameField.style.display = 'none';
                submitBtn.innerText = t.btn_login;
                toggleBtn.innerText = t.toggle_signup;
            } else {
                title.innerText = t.signup_title;
                nameField.style.display = 'block';
                submitBtn.innerText = t.btn_signup;
                toggleBtn.innerText = t.toggle_login;
            }
        }

        // --- Smart Wallet Logic ---
        let smartWalletData = JSON.parse(localStorage.getItem('smartWalletData')) || { balance: 0, transactions: [] };

        function getSmartWalletView() {
            const t = translations[currentLang];
            const cur = currencies[currentCurrency];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';

            const allTransactions = smartWalletData.transactions.slice().reverse();
            const recentTransactions = allTransactions.slice(0, 2);
            const hasMore = allTransactions.length > 2;

            const transactionsHTML = recentTransactions.map(tx => {
                const isDeposit = tx.type === 'deposit';
                const color = isDeposit ? '#22c55e' : '#ef4444';
                const icon = isDeposit ? 'fa-arrow-down' : 'fa-arrow-up';

                return `
                <div class="timeline-item">
                    <div class="timeline-line"></div>
                    <div class="timeline-icon-container" style="color: ${color}; background: ${color}10;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="timeline-content-box">
                        <div class="timeline-time">
                            <i class="far fa-clock"></i> ${formatTimeAgo(tx.timestamp)}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="timeline-title">${isDeposit ? t.log_deposit : t.log_withdraw}</div>
                            <div style="font-weight:800; color:${color}; direction: ltr;">${isDeposit ? '+' : '-'}${tx.amount} ${cur.symbol}</div>
                        </div>
                        <div class="timeline-desc">${tx.note || ''}</div>
                    </div>
                </div>
                `;
            }).join('');

            const totalDeposits = smartWalletData.transactions
                .filter(tx => tx.type === 'deposit')
                .reduce((sum, tx) => sum + tx.amount, 0);

            const totalWithdrawals = smartWalletData.transactions
                .filter(tx => tx.type === 'withdraw')
                .reduce((sum, tx) => sum + tx.amount, 0);

            return `
            <div class="glass-header" style="display:flex; align-items:center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <button data-view="home" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800; font-size: 20px;">${t.wallet_title}</h3>
                </div>
                <button onclick="openSmartWalletInfoModal()" class="btn icon-btn" style="background: var(--bg); color: var(--primary); width: 35px; height: 35px; border: 1px solid var(--border-color); border-radius: 50%;"><i class="fas fa-info-circle"></i></button>
            </div>

            <!-- Balance Card -->
            <div class="details-card" style="text-align: center; padding: 40px 20px; margin-bottom: 24px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">${t.lbl_current_balance}</div>
                <div style="font-size: 36px; font-weight: 800; margin-bottom: 30px;">${cur.symbol} ${smartWalletData.balance}</div>
                
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button onclick="openTransactionModal('deposit')" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 12px; font-weight: 700; flex: 1; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-arrow-down"></i> ${t.btn_deposit}
                    </button>
                    <button onclick="openTransactionModal('withdraw')" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 12px; font-weight: 700; flex: 1; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-arrow-up"></i> ${t.btn_withdraw}
                    </button>
                </div>
            </div>

            <!-- Totals Summary -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                <div class="card" style="padding: 16px; align-items: flex-start;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${t.lbl_total_deposits}</div>
                    <div style="font-size: 18px; font-weight: 800; color: #22c55e;">${cur.symbol} ${totalDeposits}</div>
                </div>
                <div class="card" style="padding: 16px; align-items: flex-start;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${t.lbl_total_withdrawals}</div>
                    <div style="font-size: 18px; font-weight: 800; color: #ef4444;">${cur.symbol} ${totalWithdrawals}</div>
                </div>
            </div>

            <!-- Transactions History -->
            <div class="details-card">
                <div class="details-title">${t.lbl_transaction_history}</div>
                ${allTransactions.length > 0 ? `
                    <div class="timeline-container">
                        ${transactionsHTML}
                    </div>
                    ${hasMore ? `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="openSmartWalletHistoryModal()" class="btn" style="font-size: 13px; color: var(--primary); background: var(--primary-soft); padding: 10px 20px; border-radius: 20px; font-weight: 700; transition: all 0.3s;">
                            ${t.view_more} <i class="fas fa-arrow-down" style="margin-inline-start: 5px;"></i>
                        </button>
                    </div>` : ''}
                ` : `
                    <div class="empty-state-container">
                        <div class="empty-state-icon"><i class="fas fa-history"></i></div>
                        <div class="empty-state-text">${t.empty_state_msg}</div>
                    </div>
                `}
            </div>

            <!-- Smart Wallet History Modal -->
            <div id="smartWalletHistoryModal" class="dev-modal-overlay" onclick="if(event.target === this) closeSmartWalletHistoryModal()">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: start; padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px;">${t.lbl_transaction_history}</h3>
                        <button onclick="closeSmartWalletHistoryModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="smartWalletHistoryList" style="padding: 20px; overflow-y: auto; flex: 1;">
                        <!-- Content populated by JS -->
                    </div>
                </div>
            </div>



            <!-- Info Modal -->
            <div id="smartWalletInfoModal" class="dev-modal-overlay" style="z-index: 2200;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: start; padding: 0; overflow: hidden;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-book" style="color: var(--primary);"></i> ${t.wallet_info_title}
                        </h3>
                        <button onclick="closeSmartWalletInfoModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #dcfce7; color: #16a34a; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.wallet_info_step1_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.wallet_info_step1_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #fee2e2; color: #dc2626; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.wallet_info_step2_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.wallet_info_step2_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #f3e8ff; color: #9333ea; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.wallet_info_step3_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.wallet_info_step3_desc}</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            `;
        }

        let currentTransactionType = 'deposit';

        function openTransactionModal(type) {
            const t = translations[currentLang];
            const cur = currencies[currentCurrency];
            currentTransactionType = type;
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');

            title.innerText = type === 'deposit' ? t.btn_deposit : t.btn_withdraw;

            // Update Localization
            document.getElementById('lblTransactionAmount').innerText = t.lbl_amount;
            document.getElementById('lblTransactionCurrency').innerText = cur.symbol;
            document.getElementById('lblTransactionNote').innerText = t.lbl_note;
            document.getElementById('transactionNote').placeholder = t.placeholder_note;
            document.getElementById('btnTransactionConfirm').innerText = t.msg_confirm_transaction;

            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionNote').value = '';

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function saveTransaction() {
            const amount = Number(document.getElementById('transactionAmount').value);
            const note = document.getElementById('transactionNote').value;

            if (!amount || amount <= 0) return;

            if (currentTransactionType === 'withdraw' && amount > smartWalletData.balance) {
                alert('Insufficient balance!');
                return;
            }

            if (currentTransactionType === 'deposit') {
                smartWalletData.balance += amount;
            } else {
                smartWalletData.balance -= amount;
            }

            smartWalletData.transactions.push({
                type: currentTransactionType,
                amount: amount,
                note: note,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('smartWalletData', JSON.stringify(smartWalletData));
            closeTransactionModal();
            renderView('smart_wallet');
            updateNotificationBadge();
        }

        function openSmartWalletHistoryModal() {
            const modal = document.getElementById('smartWalletHistoryModal');
            const list = document.getElementById('smartWalletHistoryList');
            const t = translations[currentLang];
            const cur = currencies[currentCurrency];

            const allTransactions = smartWalletData.transactions.slice().reverse();

            list.innerHTML = '<div class="timeline-container">' + allTransactions.map(tx => {
                const isDeposit = tx.type === 'deposit';
                const color = isDeposit ? '#22c55e' : '#ef4444';
                const icon = isDeposit ? 'fa-arrow-down' : 'fa-arrow-up';

                return `
                <div class="timeline-item">
                    <div class="timeline-line"></div>
                    <div class="timeline-icon-container" style="color: ${color}; background: ${color}10;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="timeline-content-box">
                        <div class="timeline-time">
                            <i class="far fa-clock"></i> ${formatTimeAgo(tx.timestamp)}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="timeline-title">${isDeposit ? t.log_deposit : t.log_withdraw}</div>
                            <div style="font-weight:800; color:${color}; direction: ltr;">${isDeposit ? '+' : '-'}${tx.amount} ${cur.symbol}</div>
                        </div>
                        <div class="timeline-desc">${tx.note || ''}</div>
                    </div>
                </div>
                `;
            }).join('') + '</div>';

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeSmartWalletHistoryModal() {
            const modal = document.getElementById('smartWalletHistoryModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function openSmartWalletInfoModal() {
            const modal = document.getElementById('smartWalletInfoModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeSmartWalletInfoModal() {
            const modal = document.getElementById('smartWalletInfoModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // --- Expenses View Logic ---
        // --- Expense Management Data & Logic (Multi-Period) ---

        // Data Structure:
        // allExpensePeriods = {
        //    "2023-11": { totalIncome: 0, items: [], activityLog: [] },
        //    "2023-12": { ... }
        // }

        let allExpensePeriods = JSON.parse(localStorage.getItem('allExpensePeriods')) || {};

        // Migration for existing users (single object to multi-period)
        const oldData = JSON.parse(localStorage.getItem('expenseManagerData'));
        if (oldData && !allExpensePeriods[getCurrentMonthId()]) {
            const currentMonth = getCurrentMonthId();
            allExpensePeriods[currentMonth] = oldData;
            localStorage.setItem('allExpensePeriods', JSON.stringify(allExpensePeriods));
            localStorage.removeItem('expenseManagerData'); // Cleanup
        }

        let currentPeriodId = getCurrentMonthId(); // Default to current month
        let expenseManagerData = getPeriodData(currentPeriodId);

        function getCurrentMonthId() {
            const mode = localStorage.getItem('expense_distribution_mode') || 'monthly';
            if (mode === 'permanent') return 'PERMANENT';

            const date = new Date();
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function getPeriodData(periodId) {
            if (!allExpensePeriods[periodId]) {
                // Initialize new period
                // Optional: Copy categories/budget from previous month if exists
                const prevDate = new Date(periodId + "-01");
                prevDate.setMonth(prevDate.getMonth() - 1);
                const prevPeriodId = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;

                let newItems = [];
                let newIncome = 0;

                if (periodId === 'PERMANENT') {
                    // Initialize PERMANENT from the most recent available period
                    const periods = Object.keys(allExpensePeriods).filter(k => k !== 'PERMANENT').sort().reverse();
                    if (periods.length > 0) {
                        const lastPeriod = allExpensePeriods[periods[0]];
                        newItems = lastPeriod.items.map(item => ({
                            category: item.category,
                            budget: item.budget,
                            actual: item.actual // Keep actuals for permanent mode
                        }));
                        newIncome = lastPeriod.totalIncome;
                    }
                } else if (allExpensePeriods[prevPeriodId]) {
                    // Clone categories and budget, reset actuals
                    newItems = allExpensePeriods[prevPeriodId].items.map(item => ({
                        category: item.category,
                        budget: item.budget,
                        actual: 0
                    }));
                    newIncome = allExpensePeriods[prevPeriodId].totalIncome;
                }

                allExpensePeriods[periodId] = {
                    totalIncome: newIncome,
                    items: newItems,
                    activityLog: []
                };
            }
            return allExpensePeriods[periodId];
        }

        function saveExpenses() {
            allExpensePeriods[currentPeriodId] = expenseManagerData;
            localStorage.setItem('allExpensePeriods', JSON.stringify(allExpensePeriods));
        }

        function changePeriod(periodId) {
            if (typeof periodId === 'number') {
                // Offset logic (legacy support if needed, or remove)
                const date = new Date(currentPeriodId + "-01");
                date.setMonth(date.getMonth() + periodId);
                currentPeriodId = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            } else {
                // Direct set
                currentPeriodId = periodId;
            }
            expenseManagerData = getPeriodData(currentPeriodId);
            renderView('expenses');
            updateNotificationBadge();
        }

        function openPeriodSelectionModal() {
            const modal = document.getElementById('periodSelectionModal');
            const container = document.getElementById('periodListContainer');

            // Generate list of periods (last 12 months + any future ones in data)
            const periods = Object.keys(allExpensePeriods).filter(id => id !== 'PERMANENT').sort().reverse();

            // Ensure current month is in the list if not already
            const currentMonth = getCurrentMonthId();
            if (!periods.includes(currentMonth)) periods.unshift(currentMonth);

            // Remove duplicates and sort again just in case
            const uniquePeriods = [...new Set(periods)].sort().reverse();

            container.innerHTML = uniquePeriods.map(pid => {
                const label = getPeriodLabel(pid);
                const isCurrent = pid === currentPeriodId;
                return `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <button onclick="changePeriod('${pid}'); closePeriodSelectionModal();" class="btn" style="
                        flex: 1; 
                        padding: 16px; 
                        text-align: center; 
                        background: ${isCurrent ? 'linear-gradient(135deg, var(--primary), var(--accent))' : 'var(--bg)'}; 
                        color: ${isCurrent ? 'white' : 'var(--text)'};
                        border: ${isCurrent ? 'none' : '1px solid var(--border-color)'};
                        border-radius: 16px;
                        font-weight: 800;
                        font-size: 16px;
                        box-shadow: ${isCurrent ? '0 8px 20px var(--primary-soft)' : 'none'};
                        transition: all 0.3s;
                    ">
                        ${label}
                    </button>
                    <button onclick="openDeleteConfirmModal('${pid}')" class="btn icon-btn" style="
                        width: 54px; 
                        height: 54px; 
                        border-radius: 16px; 
                        background: #fee2e2; 
                        color: #ef4444; 
                        border: 1px solid #fecaca;
                        flex-shrink: 0;
                        font-size: 20px;
                    ">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                `;
            }).join('') + `
                <div style="margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 25px;">
                    <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 12px; font-weight: 700; text-align: center;">${translations[currentLang].lbl_select_month}</label>
                    <div style="position: relative;">
                        <input type="month" onchange="changePeriod(this.value); closePeriodSelectionModal();" style="
                            width: 100%; 
                            padding: 16px; 
                            border-radius: 16px; 
                            border: 1px solid var(--border-color); 
                            background: var(--bg); 
                            color: var(--text); 
                            font-family: inherit; 
                            font-weight: 700;
                            font-size: 16px;
                            text-align: center;
                        ">
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.setAttribute('dir', translations[lang].dir);
            document.documentElement.setAttribute('lang', lang);

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.innerText = translations[lang][key];
                    }
                }
            });

            localStorage.setItem('app-language', lang);

            // Update dynamic content
            updateDynamicContent();
            updateAttendanceInfoModal();

            // Re-render current view to apply translations
            if (typeof currentView !== 'undefined') {
                renderView(currentView);
            }
        }

        function updateDynamicContent() {
            const t = translations[currentLang];

            // Update AI Modal
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiModalDesc = document.getElementById('aiModalDesc');
            const aiModalBtn = document.getElementById('aiModalBtn');

            if (aiModalTitle) aiModalTitle.textContent = t.ai_feature_title;
            if (aiModalDesc) {
                aiModalDesc.innerHTML = `
                    ${t.ai_description}
                    <br><br>
                    <span style="color: var(--primary); font-weight: 700;">${t.ai_wait_message}</span>
                `;
            }
            if (aiModalBtn) aiModalBtn.textContent = t.btn_got_it;

            // Update Notifications Modal Title
            const notifModalTitle = document.getElementById('notifModalTitle');
            if (notifModalTitle) {
                notifModalTitle.innerHTML = `<i class="fas fa-bell"></i> ${t.notifications_title}`;
            }

            // Update Smart Actions Menu
            const smartActionsTitle = document.getElementById('smartActionsTitle');
            if (smartActionsTitle) smartActionsTitle.textContent = t.smart_actions_title;

            const smartActionsMenu = document.querySelector('.smart-actions-menu');
            if (smartActionsMenu) {
                const actions = smartActionsMenu.querySelectorAll('.smart-action-label');
                if (actions[0]) actions[0].textContent = t.action_record_expense;
                if (actions[1]) actions[1].textContent = t.action_deposit;
                if (actions[2]) actions[2].textContent = t.action_attendance;
                if (actions[3]) actions[3].textContent = t.action_ai;
            }

            // Update Quick Expense Modal
            const quickExpenseTitle = document.getElementById('quickExpenseTitle');
            const quickExpenseCategoryLabel = document.getElementById('quickExpenseCategoryLabel');
            const quickExpenseAmountLabel = document.getElementById('quickExpenseAmountLabel');
            const quickExpenseCurrency = document.getElementById('quickExpenseCurrency');
            const quickExpenseSaveBtn = document.getElementById('quickExpenseSaveBtn');

            if (quickExpenseTitle) quickExpenseTitle.textContent = t.quick_expense_title;
            if (quickExpenseCategoryLabel) quickExpenseCategoryLabel.textContent = t.quick_expense_category_label;
            if (quickExpenseAmountLabel) quickExpenseAmountLabel.textContent = t.quick_expense_amount_label;
            if (quickExpenseCurrency) quickExpenseCurrency.textContent = currencies[currentCurrency].symbol;
            if (quickExpenseSaveBtn) quickExpenseSaveBtn.textContent = t.quick_expense_btn_save;
        }

        // Call updateDynamicContent on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateDynamicContent();
            updateAttendanceInfoModal();
        });

        function updateAttendanceInfoModal() {
            const t = translations[currentLang];
            const modal = document.getElementById('attendanceInfoModal');
            if (!modal) return;

            // Update title
            const titleEl = modal.querySelector('h3');
            if (titleEl) {
                titleEl.innerHTML = `<i class="fas fa-book" style="color: var(--primary);"></i> ${t.attendance_info_title}`;
            }

            // Update steps
            const steps = modal.querySelectorAll('[style*="font-weight: 800"]');
            if (steps[0]) steps[0].textContent = t.attendance_info_step1;
            if (steps[1]) steps[1].textContent = t.attendance_info_step2;
            if (steps[2]) steps[2].textContent = t.attendance_info_step3;
            if (steps[3]) steps[3].textContent = t.attendance_info_step4;

            const descs = modal.querySelectorAll('[style*="line-height: 1.6"]');
            if (descs[0]) descs[0].textContent = t.attendance_info_step1_desc;
            if (descs[1]) descs[1].textContent = t.attendance_info_step2_desc;
            if (descs[2]) descs[2].textContent = t.attendance_info_step3_desc;
            if (descs[3]) descs[3].textContent = t.attendance_info_step4_desc;
        }
        function closePeriodSelectionModal() {
            const modal = document.getElementById('periodSelectionModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        let periodToDelete = null;

        function openDeleteConfirmModal(periodId) {
            periodToDelete = periodId;
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function executeDeletePeriod() {
            if (!periodToDelete) return;

            delete allExpensePeriods[periodToDelete];
            localStorage.setItem('allExpensePeriods', JSON.stringify(allExpensePeriods));

            // If we deleted the current view, switch to default current month
            if (periodToDelete === currentPeriodId) {
                currentPeriodId = getCurrentMonthId();
                expenseManagerData = getPeriodData(currentPeriodId);
                renderView('expenses');
            }

            closeDeleteConfirmModal();
            // Refresh the modal list
            openPeriodSelectionModal();
            updateNotificationBadge();
        }

        function getPeriodLabel(periodId) {
            const t = translations[currentLang];
            if (periodId === 'PERMANENT') {
                return t.dist_mode_permanent;
            }
            const date = new Date(periodId + "-01");
            let locale = 'ar-EG';
            if (currentLang === 'en') locale = 'en-US';
            if (currentLang === 'fr') locale = 'fr-FR';
            return date.toLocaleDateString(locale, { month: 'long', year: 'numeric' });
        }

        function logActivity(actionKey, details) {
            const log = {
                timestamp: new Date().toISOString(),
                actionKey: actionKey,
                details: details
            };
            if (!expenseManagerData.activityLog) expenseManagerData.activityLog = [];
            expenseManagerData.activityLog.unshift(log);
            if (expenseManagerData.activityLog.length > 100) expenseManagerData.activityLog.pop();
            saveExpenses();
        }

        function formatTimeAgo(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        function resetPermanentPeriod() {
            const t = translations[currentLang];
            showConfirmationModal(
                t.btn_reset_period,
                t.reset_period_confirm,
                () => {
                    // Reset actuals to 0
                    expenseManagerData.items.forEach(item => item.actual = 0);
                    // Log activity
                    logActivity('log_budget_update', 'Reset Period (Permanent Mode)');
                    saveExpenses();
                    renderView('expenses');
                    updateNotificationBadge();

                    setTimeout(() => {
                        showSuccessMessage(t.reset_complete || 'Done');
                    }, 100);
                },
                'danger'
            );
        }

        function getExpensesView() {
            const t = translations[currentLang];
            const cur = currencies[currentCurrency];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';

            // Calculate Totals
            const totalBudget = expenseManagerData.items.reduce((acc, item) => acc + item.budget, 0);
            const totalActual = expenseManagerData.items.reduce((acc, item) => acc + item.actual, 0);
            const totalDiff = totalBudget - totalActual;
            const remaining = expenseManagerData.totalIncome - totalActual;

            // Chart Logic
            let chartGradient = 'conic-gradient(#e2e8f0 0% 100%)'; // Default gray
            let legendHTML = '';

            if (totalActual > 0) {
                let currentAngle = 0;
                let gradientParts = [];
                const colors = ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#6366f1', '#84cc16'];

                legendHTML = '<div class="legend-grid">';

                expenseManagerData.items.forEach((item, index) => {
                    if (item.actual > 0) {
                        const percent = (item.actual / totalActual) * 100;
                        const color = colors[index % colors.length];
                        const endAngle = currentAngle + percent;

                        gradientParts.push(`${color} ${currentAngle}% ${endAngle}%`);
                        currentAngle = endAngle;

                        legendHTML += `
                            <div class="legend-item">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${color}; flex-shrink: 0;"></span>
                                    <span style="font-size: 12px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" dir="auto">${item.category}</span>
                                </div>
                                <div style="display: flex; align-items: flex-end; justify-content: space-between;">
                                    <div style="font-size: 11px; color: var(--text-muted);">${cur.symbol} ${item.actual}</div>
                                    <div style="font-weight: 800; font-size: 14px; color: ${color};">${percent.toFixed(1)}%</div>
                                </div>
                                <div style="width: 100%; height: 4px; background: var(--surface); border-radius: 2px; overflow: hidden; margin-top: 4px;">
                                    <div style="width: ${percent}%; height: 100%; background: ${color}; border-radius: 2px;"></div>
                                </div>
                            </div>
                        `;
                    }
                });

                legendHTML += '</div>';
                chartGradient = `conic-gradient(${gradientParts.join(', ')})`;
            } else {
                legendHTML = `
                    <div style="margin-top: 30px; padding: 20px; background: var(--bg); border-radius: 16px; text-align: center;">
                        <i class="fas fa-chart-pie" style="font-size: 24px; color: var(--text-muted); margin-bottom: 10px; opacity: 0.5;"></i>
                        <div style="font-size: 13px; color: var(--text-muted);">${t.empty_state_msg}</div>
                    </div>
                `;
            }

            // Generate Table Rows
            let rowsContent = '';
            if (expenseManagerData.items.length === 0) {
                rowsContent = `
                    <div class="empty-state-container">
                        <div class="empty-state-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="empty-state-text">${t.empty_state_msg}</div>
                        <div class="empty-state-subtext">${t.empty_state_action}</div>
                    </div>
                `;
            } else {
                rowsContent = expenseManagerData.items.map((item, index) => {
                    const diff = item.budget - item.actual;
                    const diffColor = diff < 0 ? '#ef4444' : '#22c55e';
                    return `
                    <div class="expense-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; padding: 12px 0; border-bottom: 1px solid var(--border-color); align-items: center;">
                        <div style="font-weight: 600; font-size: 14px; text-align: start;">${item.category}</div>
                        <div style="text-align: center; color: var(--text-muted); font-size: 13px;">${item.budget}</div>
                        <div style="text-align: center;">
                            <button onclick="openExpenseEditModal(${index})" class="btn" style="background: var(--bg); border: 1px solid var(--border-color); padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 700; color: var(--text); display: inline-flex; align-items: center; justify-content: center; gap: 6px; width: 100%; justify-content: center;">
                                ${item.actual} <i class="fas fa-pen" style="font-size: 10px; opacity: 0.5;"></i>
                            </button>
                        </div>
                        <div style="text-align: center; color: ${diffColor}; font-weight: 700; font-size: 13px;">${diff}</div>
                    </div>
                    `;
                }).join('');
            }

            // Recent Activities Logic
            const logs = expenseManagerData.activityLog || [];
            const recentLogs = logs.slice(0, 2);
            const hasMoreLogs = logs.length > 2;

            const getActivityIcon = (key) => {
                if (key === 'log_budget_update') return 'fa-sliders';
                if (key === 'log_expense_diff') return 'fa-pen-to-square';
                return 'fa-money-bill-wave';
            };

            const getActivityColor = (key) => {
                if (key === 'log_budget_update') return '#3b82f6';
                if (key === 'log_expense_diff') return '#f59e0b';
                return '#10b981';
            };

            const activitiesHTML = recentLogs.map((log, index) => {
                const icon = getActivityIcon(log.actionKey);
                const color = getActivityColor(log.actionKey);

                return `
                <div class="timeline-item">
                    <div class="timeline-line"></div>
                    <div class="timeline-icon-container" style="color: ${color}; background: ${color}10;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="timeline-content-box">
                        <div class="timeline-time">
                            <i class="far fa-clock"></i> ${formatTimeAgo(log.timestamp)}
                        </div>
                        <div class="timeline-title">${t[log.actionKey]}</div>
                        <div class="timeline-desc">${log.details}</div>
                    </div>
                </div>
                `;
            }).join('');

            const setupIcon = expenseManagerData.items.length === 0 ? 'fa-plus' : 'fa-pen-to-square';

            // Chart Section
            const isPermanent = localStorage.getItem('expense_distribution_mode') === 'permanent';
            let periodControlHTML = '';

            // في الوضع الشهري فقط: عرض زر اختيار الشهر
            // في الوضع الدائم: لا يظهر أي زر
            if (!isPermanent) {
                periodControlHTML = `
                     <button onclick="openPeriodSelectionModal()" style="font-size: 12px; color: var(--text); background: var(--bg); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 6px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        ${getPeriodLabel(currentPeriodId)} <i class="fas fa-chevron-down" style="font-size: 10px; opacity: 0.7;"></i>
                    </button>
                `;
            }

            return `
            <div class="glass-header" style="display:flex; align-items:center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <button data-view="home" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800; font-size: 20px;">${t.expenses_title}</h3>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openExpenseInfoModal()" class="btn icon-btn" style="background: var(--bg); color: var(--primary); width: 35px; height: 35px; border: 1px solid var(--border-color); border-radius: 50%;"><i class="fas fa-info-circle"></i></button>
                    <button onclick="openBudgetSetup()" class="btn icon-btn" style="background: var(--primary); color: white; width: 35px; height: 35px; box-shadow: 0 4px 10px var(--primary-soft); border-radius: 50%;"><i class="fas ${setupIcon}"></i></button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 24px;">
                <div class="card" style="padding: 12px; align-items: flex-start; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none;">
                    <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">${t.lbl_total_income}</div>
                    <div style="font-size: 16px; font-weight: 800;">${cur.symbol} <span>${expenseManagerData.totalIncome}</span></div>
                </div>
                <div class="card" style="padding: 12px; align-items: flex-start;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">${t.lbl_total_expenses}</div>
                    <div style="font-size: 16px; font-weight: 800; color: #ef4444;">${cur.symbol} ${totalActual}</div>
                </div>
                <div class="card" style="padding: 12px; align-items: flex-start;">
                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">${t.lbl_remaining}</div>
                    <div style="font-size: 16px; font-weight: 800; color: ${remaining >= 0 ? '#10b981' : '#ef4444'};">${cur.symbol} ${remaining}</div>
                </div>
            </div>

            <!-- Professional Details Table -->
            <div class="details-card" style="margin-bottom: 24px;">
                <div class="details-title">${t.lbl_details}</div>
                
                <div class="details-table-header">
                    <div style="text-align: start;">${t.col_category}</div>
                    <div style="text-align: center;">${t.col_budget}</div>
                    <div style="text-align: center;">${t.col_actual}</div>
                    <div style="text-align: center;">${t.col_diff}</div>
                </div>

                <div id="expense-rows">
                    ${rowsContent}
                </div>
            </div>

            <!-- Chart Section -->
            <div class="details-card" style="margin-bottom: 24px;">
                <div style="position: absolute; top: 20px; left: 20px; z-index: 2;">
                     ${periodControlHTML}
                </div>
                
                <div class="details-title" style="margin-top: 50px;">${t.chart_title}</div>
                
                <div class="chart-circle-container">
                    <div style="width: 100%; height: 100%; border-radius: 50%; background: ${chartGradient}; position: relative;">
                        <div style="position: absolute; inset: 20px; background: var(--surface); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 5px 15px rgba(0,0,0,0.05);">
                            <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">${t.col_actual}</span>
                            <span style="font-size: 24px; font-weight: 800; color: var(--text);">${Math.round((totalActual / (totalBudget || 1)) * 100)}%</span>
                        </div>
                    </div>
                </div>
                
                ${legendHTML}
            </div>

            <!-- Recent Activities (Timeline Design) -->
            ${recentLogs.length > 0 ? `
            <div class="details-card" style="padding: 30px 20px; text-align: inherit;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="details-title" style="margin-bottom: 0;">${t.recent_activities}</div>
                </div>
                
                <div class="timeline-container">
                    ${activitiesHTML}
                </div>

                ${hasMoreLogs ? `
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="openActivitiesModal()" class="btn" style="font-size: 13px; color: var(--primary); background: var(--primary-soft); padding: 10px 20px; border-radius: 20px; font-weight: 700; transition: all 0.3s;">
                        ${t.view_more} <i class="fas fa-arrow-down" style="margin-inline-start: 5px;"></i>
                    </button>
                </div>` : ''}
            </div>
            ` : ''}

            <!-- Budget Setup Modal -->
            <div id="budgetModal" class="dev-modal-overlay" style="z-index: 2000;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: left; max-height: 85vh; overflow-y: auto; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
                    
                    <!-- Modal Header -->
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px;">${t.setup_budget_title}</h3>
                        <button onclick="closeBudgetModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>

                    <!-- Modal Content -->
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        
                        <!-- View Mode -->
                        <div id="setupViewMode">
                            <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, var(--primary-soft), var(--primary)); border-radius: 12px; color: white;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">${t.lbl_total_income}</div>
                                <div style="font-size: 24px; font-weight: 800;">${cur.symbol} <span id="viewTotalIncome">0</span></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label style="font-size: 13px; font-weight: 700; color: var(--text-muted);">${t.lbl_categories_budgets}</label>
                                <button onclick="toggleBudgetEditMode(true)" class="btn" style="font-size: 12px; background: var(--bg); color: var(--primary); font-weight: 700; padding: 6px 12px; border-radius: 20px;">
                                    <i class="fas fa-pen" style="margin-right: 5px;"></i> ${t.btn_edit}
                                </button>
                            </div>

                            <div id="viewCategoriesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <!-- Read-only list -->
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="setupEditMode" style="display: none;">
                            <div style="margin-bottom: 20px;">
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">${t.lbl_total_income}</label>
                                <input type="number" id="setupTotalIncome" class="splash-btn" style="background: var(--bg); color: var(--text); padding: 12px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none;" placeholder="0.00">
                            </div>

                            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-muted);">${t.lbl_categories_budgets}</label>
                                <button onclick="addCategoryRow()" class="btn" style="font-size: 12px; color: var(--primary); font-weight: 700;">${t.btn_add_new}</button>
                            </div>

                            <div id="setupCategoriesList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px;">
                                <!-- Dynamic Inputs -->
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer (Actions) -->
                    <div id="setupFooter" style="padding: 20px; border-top: 1px solid var(--border-color); background: var(--surface); display: none; gap: 10px;">
                        <button onclick="toggleBudgetEditMode(false)" class="btn" style="flex: 1; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--text-muted); font-weight: 700;">${t.btn_cancel}</button>
                        <button onclick="saveBudgetSetup()" class="splash-btn" style="flex: 2; opacity: 1; animation: none; margin: 0;">${t.btn_save_changes}</button>
                    </div>

                </div>
            </div>

            <!-- Activities Modal -->
            <div id="activitiesModal" class="dev-modal-overlay" style="z-index: 2000;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: left; max-height: 85vh; overflow-y: auto; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px;">${t.activity_history}</h3>
                        <button onclick="closeActivitiesModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div id="fullActivitiesList"></div>
                    </div>
                </div>
            </div>

            <!-- Expense Edit Modal -->
            <div id="expenseEditModal" class="dev-modal-overlay" style="z-index: 2100;">
                <div class="dev-modal" style="max-width: 400px; width: 95%; text-align: left;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px;">${t.edit_expense_title}</h3>
                        <button onclick="closeExpenseEditModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">${t.col_category}</label>
                            <div style="position: relative;">
                                <i class="fas fa-tag" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px;"></i>
                                <input type="text" id="editExpenseCategory" class="splash-btn" style="background: var(--bg); color: var(--text); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">${t.col_budget}</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; font-weight: 700;">${cur.symbol}</span>
                                    <input type="number" id="editExpenseBudget" class="splash-btn" style="background: var(--bg); color: var(--text); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none;">
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 25px;">
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">${t.lbl_previous_actual}</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; font-weight: 700;">${cur.symbol}</span>
                                    <input type="number" id="editExpensePrevActual" disabled class="splash-btn" style="background: var(--bg); color: var(--text-muted); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 0.7; animation: none; font-weight: 700; cursor: not-allowed;">
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">${t.lbl_add_amount}</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; font-weight: 700;">${cur.symbol}</span>
                                    <input type="number" id="editExpenseNewActual" class="splash-btn" style="background: var(--bg); color: var(--text); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none; font-weight: 700;" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeExpenseEditModal()" class="btn" style="flex: 1; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--text-muted); font-weight: 700;">${t.btn_cancel}</button>
                            <button onclick="saveExpenseEdit()" class="splash-btn" style="flex: 2; opacity: 1; animation: none; margin: 0;">${t.btn_save_changes}</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Period Selection Modal -->
            <div id="periodSelectionModal" class="dev-modal-overlay" style="z-index: 2300;">
                <div class="dev-modal" style="max-width: 350px; width: 90%; padding: 20px;">
                    <h3 style="margin-top: 0; margin-bottom: 20px; text-align: center;">${t.activity_history}</h3>
                    <div id="periodListContainer" style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto;">
                        <!-- Periods will be injected here -->
                    </div>
                    <button onclick="closePeriodSelectionModal()" class="btn" style="margin-top: 20px; width: 100%; background: var(--bg); color: var(--text-muted);">${t.btn_cancel}</button>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div id="deleteConfirmModal" class="dev-modal-overlay" style="z-index: 2400;">
                <div class="dev-modal" style="max-width: 320px; width: 90%; padding: 25px; text-align: center;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: #fee2e2; color: #ef4444; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 20px auto;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="margin: 0 0 10px 0; font-size: 18px; font-weight: 800;">${t.delete_title}</h3>
                    <p style="margin: 0 0 25px 0; color: var(--text-muted); font-size: 14px; line-height: 1.5;">${t.delete_period_confirm}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeDeleteConfirmModal()" class="btn" style="flex: 1; padding: 12px; border-radius: 12px; background: var(--bg); color: var(--text); font-weight: 700;">${t.btn_cancel}</button>
                        <button onclick="executeDeletePeriod()" class="btn" style="flex: 1; padding: 12px; border-radius: 12px; background: #ef4444; color: white; font-weight: 700; border: none;">${t.btn_delete}</button>
                    </div>
                </div>
            </div>

            <!-- Info Modal -->
            <div id="expenseInfoModal" class="dev-modal-overlay" style="z-index: 2200;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: start; padding: 0; overflow: hidden;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-book" style="color: var(--primary);"></i> ${t.info_title}
                        </h3>
                        <button onclick="closeExpenseInfoModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: var(--primary-soft); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.info_step1_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.info_step1_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #e0f2fe; color: #0ea5e9; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.info_step2_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.info_step2_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #fef3c7; color: #d97706; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.info_step3_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.info_step3_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #f3e8ff; color: #9333ea; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.info_step4_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.info_step4_desc}</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            `;
        }

        function updateExpense(index, field, value) {
            // Deprecated in favor of Modal, but kept for safety if needed
            const newValue = Number(value);
            const item = expenseManagerData.items[index];
            const oldValue = item[field];

            item[field] = newValue;

            if (field === 'actual' && oldValue !== newValue) {
                const diff = newValue - oldValue;
                const cur = currencies[currentCurrency];
                const sign = diff > 0 ? '+' : '';
                const details = `${item.category}: <span dir="ltr" style="color: ${diff > 0 ? '#ef4444' : '#22c55e'}; font-weight:700;">${sign}${diff} ${cur.symbol}</span>`;
                logActivity('log_expense_diff', details);
            }

            saveExpenses();
            renderView('expenses');
        }

        function openActivitiesModal() {
            const modal = document.getElementById('activitiesModal');
            const list = document.getElementById('fullActivitiesList');
            const t = translations[currentLang];
            const logs = expenseManagerData.activityLog || [];

            const getActivityIcon = (key) => {
                if (key === 'log_budget_update') return 'fa-sliders';
                if (key === 'log_expense_diff') return 'fa-pen-to-square';
                return 'fa-money-bill-wave';
            };

            const getActivityColor = (key) => {
                if (key === 'log_budget_update') return '#3b82f6';
                if (key === 'log_expense_diff') return '#f59e0b';
                return '#10b981';
            };

            list.innerHTML = logs.map((log, index) => {
                const isLast = index === logs.length - 1;
                const icon = getActivityIcon(log.actionKey);
                const color = getActivityColor(log.actionKey);

                return `
                <div style="display: flex; gap: 16px; position: relative; padding-bottom: ${isLast ? '0' : '24px'};">
                    ${!isLast ? `<div style="position: absolute; left: 15px; top: 30px; bottom: 0; width: 2px; background: var(--border-color); opacity: 0.5;"></div>` : ''}
                    
                    <div style="width: 32px; height: 32px; border-radius: 10px; background: ${color}15; color: ${color}; display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 1; flex-shrink: 0;">
                        <i class="fas ${icon}"></i>
                    </div>
                    
                    <div style="flex: 1; padding-top: 2px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                            <div style="font-weight: 700; font-size: 14px; color: var(--text);">${t[log.actionKey]}</div>
                            <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap;">${new Date(log.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); line-height: 1.5; background: var(--bg); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); text-align: start;">${log.details}</div>
                    </div>
                </div>
                `;
            }).join('');

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeActivitiesModal() {
            const modal = document.getElementById('activitiesModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        // --- Expense Edit Modal Logic ---
        let currentEditingIndex = -1;

        function openExpenseEditModal(index) {
            currentEditingIndex = index;
            const item = expenseManagerData.items[index];
            const modal = document.getElementById('expenseEditModal');

            document.getElementById('editExpenseCategory').value = item.category;
            document.getElementById('editExpenseBudget').value = item.budget;
            document.getElementById('editExpensePrevActual').value = item.actual;
            // Clear the "Add Amount" field so user can type new amount
            document.getElementById('editExpenseNewActual').value = '';
            document.getElementById('editExpenseNewActual').placeholder = '0';

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeExpenseEditModal() {
            const modal = document.getElementById('expenseEditModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function openExpenseInfoModal() {
            const modal = document.getElementById('expenseInfoModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeExpenseInfoModal() {
            const modal = document.getElementById('expenseInfoModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function saveExpenseEdit() {
            if (currentEditingIndex === -1) return;

            const newCategory = document.getElementById('editExpenseCategory').value;
            const newBudget = Number(document.getElementById('editExpenseBudget').value);
            const addedAmount = Number(document.getElementById('editExpenseNewActual').value);

            const item = expenseManagerData.items[currentEditingIndex];
            const oldActual = item.actual;
            const oldBudget = item.budget;
            const oldCategory = item.category;

            // Update Data
            item.category = newCategory;
            item.budget = newBudget;

            // Logic Change: Add to existing actual instead of replacing
            // If addedAmount is 0 or empty, we don't change the actual (unless user wants to just edit budget/category)
            // But let's assume if they type nothing, it adds 0.
            const newActual = oldActual + addedAmount;
            item.actual = newActual;

            // Log Changes
            const cur = currencies[currentCurrency];

            // Log Actual Diff (Added Amount)
            if (addedAmount !== 0) {
                const sign = addedAmount > 0 ? '+' : '';
                const details = `${newCategory}: <span dir="ltr" style="color: ${addedAmount > 0 ? '#ef4444' : '#22c55e'}; font-weight:700;">${sign}${addedAmount} ${cur.symbol}</span>`;
                logActivity('log_expense_diff', details);
            }

            // Log Budget/Category Changes (Simplified log)
            if (oldBudget !== newBudget || oldCategory !== newCategory) {
                logActivity('log_budget_update', `${newCategory} (Edited)`);
            }

            saveExpenses();
            closeExpenseEditModal();
            renderView('expenses');
            updateNotificationBadge();
        }

        function openBudgetSetup() {
            const modal = document.getElementById('budgetModal');
            const viewTotal = document.getElementById('viewTotalIncome');
            const viewList = document.getElementById('viewCategoriesList');
            const cur = currencies[currentCurrency];

            // Populate View Mode
            viewTotal.innerText = expenseManagerData.totalIncome;
            viewList.innerHTML = expenseManagerData.items.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px; background: var(--bg); border-radius: 8px; font-size: 13px;">
                    <span style="font-weight: 600;">${item.category}</span>
                    <span style="color: var(--text-muted);">${cur.symbol} ${item.budget}</span>
                </div>
            `).join('');

            // Reset to View Mode
            toggleBudgetEditMode(false);

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function toggleBudgetEditMode(isEdit) {
            const viewMode = document.getElementById('setupViewMode');
            const editMode = document.getElementById('setupEditMode');
            const footer = document.getElementById('setupFooter');
            const incomeInput = document.getElementById('setupTotalIncome');
            const list = document.getElementById('setupCategoriesList');

            if (isEdit) {
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                footer.style.display = 'flex';

                // Populate Edit Inputs
                incomeInput.value = expenseManagerData.totalIncome;
                list.innerHTML = '';
                if (expenseManagerData.items.length === 0) {
                    addCategoryRow();
                } else {
                    expenseManagerData.items.forEach(item => addCategoryRow(item.category, item.budget));
                }
            } else {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
                footer.style.display = 'none';
            }
        }

        function closeBudgetModal() {
            const modal = document.getElementById('budgetModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function addCategoryRow(name = '', budget = 0) {
            const t = translations[currentLang];
            const list = document.getElementById('setupCategoriesList');
            const div = document.createElement('div');
            div.className = 'setup-row';
            div.style.display = 'flex';
            div.style.gap = '8px';
            div.innerHTML = `
                <input type="text" class="cat-name" value="${name}" placeholder="${t.placeholder_category}" style="flex: 2; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text);">
                <input type="number" class="cat-budget" value="${budget}" placeholder="${t.placeholder_budget}" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text);">
                <button onclick="this.parentElement.remove()" class="btn icon-btn" style="color: #ef4444;"><i class="fas fa-trash"></i></button>
            `;
            list.appendChild(div);
        }

        function saveBudgetSetup() {
            const income = Number(document.getElementById('setupTotalIncome').value);
            const rows = document.querySelectorAll('.setup-row');
            const newItems = [];

            rows.forEach(row => {
                const name = row.querySelector('.cat-name').value;
                const budget = Number(row.querySelector('.cat-budget').value);
                if (name) {
                    // Try to preserve actual if category exists
                    const existing = expenseManagerData.items.find(i => i.category === name);
                    const actual = existing ? existing.actual : 0;
                    newItems.push({ category: name, budget: budget, actual: actual });
                }
            });

            expenseManagerData.totalIncome = income;
            expenseManagerData.items = newItems;

            logActivity('log_budget_update', `Income: ${income}, Categories: ${newItems.length}`);
            saveExpenses();

            // Re-populate view mode and switch back
            // Actually, we should probably close or just update view. 
            // Let's update view and stay in modal? Or close?
            // User usually expects close on save.
            closeBudgetModal();
            renderView('expenses');
            updateNotificationBadge();
        }

        // --- Attendance Logic ---
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || { records: {}, activities: [] };
        let selectedDate = null;
        let currentCalendarDate = new Date();

        function getAttendanceView() {
            const t = translations[currentLang];
            const backArrow = currentLang === 'ar' ? 'fa-arrow-right' : 'fa-arrow-left';
            const iconPrev = currentLang === 'ar' ? 'fa-chevron-right' : 'fa-chevron-left';
            const iconNext = currentLang === 'ar' ? 'fa-chevron-left' : 'fa-chevron-right';

            // Workplace Info
            const workplace = attendanceData.workplace || null;

            // --- INITIAL SETUP VIEW (Inline) ---
            if (!workplace) {
                return `
                <div class="glass-header" style="display:flex; align-items:center; gap: 12px; margin-bottom: 30px;">
                    <button data-view="home" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    <h3 style="margin:0; font-weight:800; font-size: 20px;">${t.card_attendance}</h3>
                </div>

                <div class="details-card" style="max-width: 400px; margin: 40px auto; padding: 40px 25px;">
                    <div style="width: 60px; height: 60px; background: var(--primary-soft); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 20px;">
                        <i class="fas fa-building-user"></i>
                    </div>
                    <h2 style="font-size: 22px; font-weight: 800; margin-bottom: 10px;">${t.setup_workspace_title}</h2>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 30px; line-height: 1.6;">
                ${t.setup_workspace_desc}
            </p>
            
            <div style="margin-bottom: 30px; text-align: center;">
                 <div style="width: 100px; height: 100px; border-radius: 24px; background: var(--bg); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--border-color); position: relative; transition: all 0.3s;">
                    <img id="setupLogoPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    <i class="fas fa-camera" style="font-size: 28px; color: var(--text-muted);" id="setupLogoIcon"></i>
                    <input type="file" id="setupLogoInput" accept="image/*" onchange="handleLogoUpload(this)" style="position: absolute; inset: 0; opacity: 0; cursor: pointer;">
                </div>
                <div style="font-size: 13px; font-weight: 600; color: var(--primary);">${t.setup_logo_optional}</div>
            </div>

            <div style="margin-bottom: 30px; text-align: start;">
                <label style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 14px;">${t.setup_workspace_name_label}</label>
                <input type="text" id="setupWorkplaceName" placeholder="${t.setup_workspace_name_placeholder}" style="width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text); font-family: inherit; font-size: 15px; transition: border-color 0.3s;">
            </div>

            <button onclick="saveAttendanceSetup()" class="splash-btn" style="width: 100%; justify-content: center; font-size: 16px; padding: 14px;">
                ${t.btn_save_start} <i class="fas ${currentLang === 'ar' ? 'fa-arrow-left' : 'fa-arrow-right'}" style="margin-right: 10px;"></i>
            </button>
                </div>
                `;
            }

            // --- DASHBOARD VIEW ---
            const logoHTML = workplace.logo
                ? `<img src="${workplace.logo}" style="width: 38px; height: 38px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border-color);">`
                : `<div style="width: 38px; height: 38px; border-radius: 12px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center;"><i class="fas fa-building"></i></div>`;

            const headerContent = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    ${logoHTML}
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <span style="font-weight: 800; font-size: 15px; line-height: 1.2;">${workplace.name}</span>
                        <span style="font-size: 11px; color: var(--text-muted);">${t.card_attendance}</span>
                    </div>
                </div>
            `;

            // Calculate Stats for Current Month
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let presentCount = 0;
            let absentCount = 0;

            // Calculate working days (excluding Fridays)
            let workDaysCount = 0;
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                if (d.getDay() !== 5) workDaysCount++; // 5 is Friday
            }

            // Count records
            Object.keys(attendanceData.records).forEach(dateStr => {
                const d = new Date(dateStr);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    if (attendanceData.records[dateStr] === 'present') presentCount++;
                    if (attendanceData.records[dateStr] === 'absent') absentCount++;
                }
            });

            // Calendar Rendering
            const monthName = t.months_long[month];
            const firstDay = new Date(year, month, 1).getDay(); // 0=Sun

            let daysHTML = '';
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                daysHTML += `<div></div>`;
            }

            // Days
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const status = attendanceData.records[dateStr];
                const isSelected = selectedDate === dateStr;
                const isToday = isCurrentMonth && i === todayDate;

                let classes = 'cal-day';
                if (status) classes += ` ${status}`;
                if (isSelected) classes += ' selected';

                // Special styling for today
                let todayStyle = '';
                let dayContent = i;
                if (isToday) {
                    todayStyle = 'position: relative; border: 2px solid var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); font-weight: 800;';
                    dayContent = `<div style="position: relative;">${i}<div style="position: absolute; top: -8px; right: -8px; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; border: 2px solid var(--surface);"></div></div>`;
                }

                daysHTML += `<div onclick="selectAttendanceDate('${dateStr}')" class="${classes}" style="${todayStyle}">${dayContent}</div>`;
            }

            // Recent Activities
            const recentActivities = attendanceData.activities.slice(0, 2);
            const activitiesHTML = recentActivities.map(act => {
                const isAbsent = act.type === 'absent';
                const color = isAbsent ? '#ef4444' : '#10b981';
                const icon = isAbsent ? 'fa-user-xmark' : 'fa-user-check';
                const label = isAbsent ? t.attendance_activity_absent : t.attendance_activity_present;

                return `
        <div class="timeline-item">
            <div style="width: 45px; height: 45px; border-radius: 14px; background: ${color}15; color: ${color}; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                <i class="fas ${icon}"></i>
            </div>
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <div style="font-weight: 700; font-size: 15px; color: var(--text);">${label}</div>
                    <div style="font-size: 12px; color: var(--text-muted); font-weight: 600;">${act.date}</div>
                </div>
                <div style="font-size: 13px; color: var(--text-muted);">${t.attendance_activity_recorded}</div>
            </div>
        </div>
        `;
            }).join('');

            // Calculate Last 6 Months Stats for Chart
            const chartStats = [];
            // Use currentCalendarDate to allow navigating into future/past months
            const referenceDate = new Date(currentCalendarDate);
            let maxVal = 0;

            for (let i = 5; i >= 0; i--) {
                const d = new Date(referenceDate.getFullYear(), referenceDate.getMonth() - i, 1);
                const y = d.getFullYear();
                const m = d.getMonth();
                const monthKey = `${y}-${String(m + 1).padStart(2, '0')}`;

                let absent = 0;
                let present = 0;

                Object.keys(attendanceData.records).forEach(dateStr => {
                    if (dateStr.startsWith(monthKey)) {
                        if (attendanceData.records[dateStr] === 'absent') absent++;
                        if (attendanceData.records[dateStr] === 'present') present++;
                    }
                });

                if (absent > maxVal) maxVal = absent;
                if (present > maxVal) maxVal = present;

                chartStats.push({
                    month: t.months_long[m], // Full name as requested
                    fullMonth: t.months_long[m],
                    absent,
                    present
                });
            }

            // Ensure maxVal is at least 5 for scale
            if (maxVal < 5) maxVal = 5;

            const chartHTML = chartStats.map(stat => {
                const absentH = (stat.absent / maxVal) * 100;
                const presentH = (stat.present / maxVal) * 100;

                return `
                <div class="chart-bar-group">
                    <div class="chart-value-popup">${stat.fullMonth}: ${stat.present} ${t.attendance_legend_present}, ${stat.absent} ${t.attendance_legend_absent}</div>
                    <div class="chart-bars-wrapper">
                        <div class="chart-bar present" style="height: ${presentH}%;"></div>
                        <div class="chart-bar absent" style="height: ${absentH}%;"></div>
                    </div>
                    <div class="chart-label">${stat.month}</div>
                </div>
                `;
            }).join('');

            return `
            <div class="glass-header" style="display:flex; align-items:center; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap: 12px; flex: 1;">
                    <button data-view="home" class="btn icon-btn"><i class="fas ${backArrow}"></i></button>
                    ${headerContent}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="openAttendanceInfoModal()" class="btn icon-btn" style="background: var(--bg); color: var(--primary); width: 35px; height: 35px; border: 1px solid var(--border-color); border-radius: 50%;"><i class="fas fa-info-circle"></i></button>
                    <button onclick="openAttendanceSetupModal()" class="btn icon-btn"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="attendance-stats">
                <div class="stat-card">
                    <div class="stat-lbl">${t.attendance_days_present}</div>
                    <div class="stat-val" style="color: #10b981;">${presentCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">${t.attendance_days_absent}</div>
                    <div class="stat-val" style="color: #ef4444;">${absentCount}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">${t.attendance_work_days}</div>
                    <div class="stat-val">${workDaysCount}</div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="calendar-wrapper">
                <div class="cal-header">
                    <button onclick="changeAttendanceMonth(-1)" class="btn icon-btn"><i class="fas ${iconPrev}"></i></button>
                    <div style="font-weight: 800; font-size: 18px;">${monthName} ${year}</div>
                    <button onclick="changeAttendanceMonth(1)" class="btn icon-btn"><i class="fas ${iconNext}"></i></button>
                </div>
                
                <div class="cal-grid">
                    ${t.days_short.map(d => `<div class="cal-day-header">${d}</div>`).join('')}
                </div>
                <div class="cal-grid" style="margin-top: 10px;">
                    ${daysHTML}
                </div>

                <!-- Action Buttons (Visible when date selected) -->
                <div class="action-buttons">
                    <button onclick="updateAttendanceStatus(null)" class="action-btn clear">
                        <i class="fas fa-eraser"></i> ${t.attendance_btn_clear}
                    </button>
                    <button onclick="updateAttendanceStatus('absent')" class="action-btn absent">
                        <i class="fas fa-user-xmark"></i> ${t.attendance_btn_absent}
                    </button>
                    <button onclick="updateAttendanceStatus('present')" class="action-btn present">
                        <i class="fas fa-briefcase"></i> ${t.attendance_btn_present}
                    </button>
                </div>
            </div>

            <!-- Professional Chart Section -->
            <div class="details-card" style="margin-bottom: 20px; padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-weight: 800; font-size: 16px;">${t.attendance_trend_title}</div>
                    <div style="display: flex; gap: 15px; font-size: 11px; font-weight: 600;">
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span> ${t.attendance_legend_present}</div>
                        <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span> ${t.attendance_legend_absent}</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-grid-line" style="top: 0;"></div>
                    <div class="chart-grid-line" style="top: 33%;"></div>
                    <div class="chart-grid-line" style="top: 66%;"></div>
                    ${chartHTML}
                </div>
            </div>

            <!-- Activities List (Redesigned) -->
            <div class="details-card">
                <div class="details-title">${t.attendance_activities_title}</div>
                <div class="timeline-container">
                    ${activitiesHTML}
                </div>
                
                <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <button onclick="openAttendanceActivitiesModal()" class="btn" style="color: var(--primary); font-weight: 700; font-size: 14px;">
                        ${t.attendance_view_more} <i class="fas ${backArrow}" style="font-size: 12px;"></i>
                    </button>
                </div>
            </div>

            <!-- Attendance Activities Modal -->
            <div id="attendanceActivitiesModal" class="dev-modal-overlay" style="z-index: 2000;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: start; max-height: 85vh; overflow-y: auto; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px;">${t.attendance_modal_title}</h3>
                        <button onclick="closeAttendanceActivitiesModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div id="attendanceActivitiesList" class="timeline-container"></div>
                    </div>
                </div>
            </div>

            <!-- Setup Modal -->
            <div id="attendanceSetupModal" class="dev-modal-overlay" style="z-index: 2100; display: none;">
                <div class="dev-modal" style="max-width: 350px; width: 90%;">
                    <h3 style="margin-bottom: 20px; font-size: 18px;">${t.setup_workspace_title}</h3>
                    
                    <div style="margin-bottom: 20px; text-align: center;">
                         <div style="width: 80px; height: 80px; border-radius: 20px; background: var(--bg); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px dashed var(--border-color); position: relative;">
                            <img id="setupLogoPreview" src="${workplace?.logo || ''}" style="width: 100%; height: 100%; object-fit: cover; display: ${workplace?.logo ? 'block' : 'none'};">
                            <i class="fas fa-camera" style="font-size: 24px; color: var(--text-muted); display: ${workplace?.logo ? 'none' : 'block'};" id="setupLogoIcon"></i>
                            <input type="file" id="setupLogoInput" accept="image/*" onchange="handleLogoUpload(this)" style="position: absolute; inset: 0; opacity: 0; cursor: pointer;">
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">${t.setup_logo_optional}</div>
                    </div>

                    <div style="margin-bottom: 25px; text-align: start;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 700; font-size: 13px;">${t.setup_workspace_name_label}</label>
                        <input type="text" id="setupWorkplaceName" value="${workplace?.name || ''}" placeholder="${t.setup_workspace_name_placeholder}" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg); color: var(--text); font-family: inherit;">
                    </div>

                    <button onclick="saveAttendanceSetup()" class="splash-btn" style="width: 100%; justify-content: center;">${t.btn_save_start}</button>
                </div>
            </div>

            <!-- Info Modal -->
            <div id="attendanceInfoModal" class="dev-modal-overlay" style="z-index: 2200;">
                <div class="dev-modal" style="max-width: 450px; width: 95%; text-align: start; padding: 0; overflow: hidden;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                        <h3 style="font-weight: 800; margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-book" style="color: var(--primary);"></i> ${t.attendance_info_title}
                        </h3>
                        <button onclick="closeAttendanceInfoModal()" class="btn icon-btn" style="width: 30px; height: 30px;"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #dcfce7; color: #16a34a; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.attendance_info_step1}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.attendance_info_step1_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #dbeafe; color: #2563eb; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.attendance_info_step2}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.attendance_info_step2_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; margin-bottom: 24px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #fef3c7; color: #d97706; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-building-user"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.setup_workspace_title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.attendance_info_step3_desc}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; align-items: flex-start;">
                            <div style="width: 42px; height: 42px; border-radius: 12px; background: #f3e8ff; color: #9333ea; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; margin-top: 2px;">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${t.attendance_info_step4}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;">${t.attendance_info_step4_desc}</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            `;
        }

        // --- Attendance Setup Helpers ---
        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('setupLogoPreview').src = e.target.result;
                    document.getElementById('setupLogoPreview').style.display = 'block';
                    document.getElementById('setupLogoIcon').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveAttendanceSetup() {
            const t = translations[currentLang];
            const name = document.getElementById('setupWorkplaceName').value;
            if (!name) return alert(t.alert_workspace_name_required);

            const logoPreview = document.getElementById('setupLogoPreview');
            const hasLogo = logoPreview.style.display === 'block';

            attendanceData.workplace = {
                name: name,
                logo: hasLogo ? logoPreview.src : ''
            };

            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            renderView('attendance');
        }

        function openAttendanceSetupModal() {
            const modal = document.getElementById('attendanceSetupModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function openAttendanceInfoModal() {
            const modal = document.getElementById('attendanceInfoModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeAttendanceInfoModal() {
            const modal = document.getElementById('attendanceInfoModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function openAttendanceActivitiesModal() {
            const modal = document.getElementById('attendanceActivitiesModal');
            const list = document.getElementById('attendanceActivitiesList');
            const t = translations[currentLang];

            // Filter for current viewed month
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;

            const monthActivities = attendanceData.activities.filter(act => act.date.startsWith(monthKey));

            if (monthActivities.length === 0) {
                list.innerHTML = `
                    <div class="empty-state-container">
                        <div class="empty-state-icon"><i class="fas fa-clipboard-list"></i></div>
                        <div class="empty-state-text">${t.attendance_no_activities}</div>
                    </div>`;
            } else {
                list.innerHTML = monthActivities.map((act) => {
                    const isAbsent = act.type === 'absent';
                    const color = isAbsent ? '#ef4444' : '#10b981';
                    const icon = isAbsent ? 'fa-user-xmark' : 'fa-user-check';
                    const label = isAbsent ? t.attendance_activity_absent : t.attendance_activity_present;

                    return `
                <div class="timeline-item">
                    <div style="width: 45px; height: 45px; border-radius: 14px; background: ${color}15; color: ${color}; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="font-weight: 700; font-size: 15px; color: var(--text);">${label}</div>
                            <div style="font-size: 12px; color: var(--text-muted); font-weight: 600;">${act.date}</div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted);">${t.attendance_activity_recorded}</div>
                    </div>
                </div>
                `;
                }).join('');
            }

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeAttendanceActivitiesModal() {
            const modal = document.getElementById('attendanceActivitiesModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function changeAttendanceMonth(delta) {
            // Set to 1st of month to avoid overflow issues (e.g. Oct 31 -> Nov 30)
            currentCalendarDate.setDate(1);
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderView('attendance');
        }

        function selectAttendanceDate(dateStr) {
            selectedDate = dateStr;
            renderView('attendance');
        }

        function updateAttendanceStatus(status) {
            if (!selectedDate) return;

            if (status === 'clear') {
                delete attendanceData.records[selectedDate];
            } else {
                attendanceData.records[selectedDate] = status;

                // Add activity
                attendanceData.activities.unshift({
                    type: status,
                    date: selectedDate,
                    timestamp: new Date().toISOString()
                });
                if (attendanceData.activities.length > 10) attendanceData.activities.pop();
            }

            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            renderView('attendance');
            updateNotificationBadge();
        }

        function renderView(viewName) {
            currentView = viewName;
            let content = '';
            const t = translations[currentLang];

            switch (viewName) {
                case 'home': content = getHomeView(); break;
                case 'settings':
                    content = getSettingsView();
                    break;
                case 'backup':
                    content = getBackupView();
                    break;
                case 'themes': content = getThemesView(); break;
                case 'languages': content = getLanguagesView(); break;
                case 'currencies': content = getCurrenciesView(); break;
                case 'expense_dist': content = getExpenseDistView(); break;
                case 'expenses': content = getExpensesView(); break;
                case 'smart_wallet': content = getSmartWalletView(); break;
                case 'attendance': content = getAttendanceView(); break;
                case 'about': content = getAboutView(); break;
                default: content = `<div class="card" style="padding:40px; text-align:center; color: var(--text-muted);">
                    <i class="fa-solid fa-person-digging" style="font-size: 40px; margin-bottom: 15px;"></i>
                    <div>${t.page_construction}</div>
                </div>`;
            }

            mainContent.innerHTML = content;

            triggerEntranceAnimations();

            if (viewName === 'home') {
                const greetingEl = document.getElementById('greeting');
                const userName = localStorage.getItem('user_name') || ' ';
                if (greetingEl) greetingEl.innerText = t.greeting_welcome + "، " + userName + " 👋";

                const dateElement = document.getElementById('currentDateText');
                if (dateElement) {
                    let locale = 'ar-EG';
                    if (currentLang === 'en') locale = 'en-US';
                    if (currentLang === 'fr') locale = 'fr-FR';

                    dateElement.textContent = new Date().toLocaleDateString(locale, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
        }

        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-view]');
            if (target) {
                const viewName = target.dataset.view;
                renderView(viewName);
                if (target.matches('.nav-link') || target.matches('.dock-item')) {
                    activate(target);
                }
            }

            const themeCard = e.target.closest('.theme-card');
            if (themeCard) {
                applyThemeSet(themeCard.dataset.theme);
            }

            const langCard = e.target.closest('.lang-card');
            if (langCard) {
                setLanguage(langCard.dataset.langCode);
            }

            const currencyCard = e.target.closest('.currency-card');
            if (currencyCard) {
                setCurrency(currencyCard.dataset.currencyCode);
            }

            const clickable = e.target.closest('.card, .btn, .click-target');
            if (clickable) {
                clickable.classList.add('click-effect');
                setTimeout(() => clickable.classList.remove('click-effect'), 150);
            }
        });

        const themes = {
            'lavender-light': { name: 'خزامى', type: 'light', colors: { '--primary': '#8b5cf6', '--accent': '#ec4899', '--bg': '#f5f3ff', '--surface': '#ffffff' } },
            'default-light': { name: 'أخضر', type: 'light', colors: { '--primary': '#16a34a', '--accent': '#3b82f6', '--bg': '#f8fafc', '--surface': '#ffffff' } },
            'ocean-light': { name: 'محيط', type: 'light', colors: { '--primary': '#3b82f6', '--accent': '#0ea5e9', '--bg': '#e0f2fe', '--surface': '#ffffff' } },
            'forest-light': { name: 'غابة', type: 'light', colors: { '--primary': '#16a34a', '--accent': '#d97706', '--bg': '#f0fdf4', '--surface': '#ffffff' } },
            'sunset-light': { name: 'غروب', type: 'light', colors: { '--primary': '#f97316', '--accent': '#7c3aed', '--bg': '#fff7ed', '--surface': '#ffffff' } },
            'rose-light': { name: 'وردي', type: 'light', colors: { '--primary': '#e11d48', '--accent': '#f43f5e', '--bg': '#fff1f2', '--surface': '#ffffff' } },
            'indigo-light': { name: 'نيلي', type: 'light', colors: { '--primary': '#4f46e5', '--accent': '#6366f1', '--bg': '#eef2ff', '--surface': '#ffffff' } },
            'mint-light': { name: 'نعناع', type: 'light', colors: { '--primary': '#10b981', '--accent': '#0ea5e9', '--bg': '#ecfdf5', '--surface': '#ffffff' } },
            'default-dark': { name: 'داكن', type: 'dark', colors: { '--primary': '#22c55e', '--accent': '#3b82f6', '--bg': '#0f172a', '--surface': '#1e293b' } },
        };

        const currencies = {
            'DZD': {
                symbols: { ar: 'د.ج', en: 'DZD', fr: 'DA' },
                countryCode: 'dz',
                get symbol() { return this.symbols[currentLang] || this.symbols.ar; }
            },
            'USD': {
                symbols: { ar: '$', en: '$', fr: '$' },
                countryCode: 'us',
                get symbol() { return this.symbols[currentLang] || this.symbols.en; }
            },
            'EUR': {
                symbols: { ar: '€', en: '€', fr: '€' },
                countryCode: 'eu',
                get symbol() { return this.symbols[currentLang] || this.symbols.en; }
            },
            'SAR': {
                symbols: { ar: 'ر.س', en: 'SAR', fr: 'SAR' },
                countryCode: 'sa',
                get symbol() { return this.symbols[currentLang] || this.symbols.ar; }
            },
            'EGP': {
                symbols: { ar: 'ج.م', en: 'EGP', fr: 'LE' },
                countryCode: 'eg',
                get symbol() { return this.symbols[currentLang] || this.symbols.ar; }
            }
        };

        let currentTheme = localStorage.getItem('app-theme') || 'lavender-light';
        let currentCurrency = localStorage.getItem('app-currency') || 'DZD';

        function applyThemeSet(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            const root = document.documentElement;
            Object.entries(theme.colors).forEach(([key, value]) => {
                root.style.setProperty(key, value);
            });
            localStorage.setItem('app-theme', themeName);
            currentTheme = themeName;
            if (currentView === 'themes') renderView('themes');
        }

        function setCurrency(code) {
            if (!currencies[code]) return;
            currentCurrency = code;
            localStorage.setItem('app-currency', code);
            if (currentView === 'currencies') renderView('currencies');
            else renderView(currentView); // Refresh to show new currency symbol
        }

        applyThemeSet(currentTheme);
        setLanguage(currentLang);

        function showLanguageSelection() {
            const step1 = document.getElementById('splash-step-1');
            const step2 = document.getElementById('splash-step-2');

            step1.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            step1.style.opacity = '0';
            step1.style.transform = 'translateY(-20px)';

            setTimeout(() => {
                step1.style.display = 'none';
                step2.style.display = 'block';
            }, 400);
        }

        function handleSplashStart() {
            if (localStorage.getItem('setup_complete') === 'true') {
                hideSplash();
            } else {
                showLanguageSelection();
            }
        }

        function selectLanguageAndStart(lang) {
            localStorage.setItem('setup_complete', 'true');
            setLanguage(lang);
            hideSplash();
        }

        function hideSplash() {
            document.getElementById('splash-screen').classList.add('hidden');
        }

        // --- Advanced Settings Functions ---
        let confirmationCallback = null;

        function showConfirmationModal(title, message, onConfirm, type = 'danger') {
            const t = translations[currentLang];
            const modal = document.getElementById('confirmationModal');
            const header = document.getElementById('confirmModalHeader');
            const icon = document.getElementById('confirmModalIcon');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const confirmBtnText = document.getElementById('confirmModalConfirmBtnText');
            const cancelBtnText = document.getElementById('confirmModalCancelBtn');

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtnText.textContent = t.btn_confirm;
            cancelBtnText.textContent = t.btn_cancel_action;

            // Reset button visibility and style
            cancelBtnText.style.display = 'inline-block';
            confirmBtn.style.flex = 'none';
            confirmBtn.onclick = executeConfirmation; // Re-attach original handler

            // Set style based on type
            if (type === 'danger') {
                header.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                icon.className = 'fas fa-exclamation-triangle';
                confirmBtn.style.background = '#ef4444';
                confirmBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)';
            } else if (type === 'warning') {
                header.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                icon.className = 'fas fa-broom';
                confirmBtn.style.background = '#f59e0b';
                confirmBtn.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.3)';
            }

            // Store callback
            confirmationCallback = onConfirm;

            // Show modal
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('open');
            setTimeout(() => {
                modal.style.display = 'none';
                confirmationCallback = null;
            }, 300);
        }

        function executeConfirmation() {
            if (confirmationCallback) {
                // Close confirmation modal first
                const modal = document.getElementById('confirmationModal');
                modal.classList.remove('open');

                // Execute callback immediately
                setTimeout(() => {
                    modal.style.display = 'none';
                    confirmationCallback();
                    confirmationCallback = null;
                }, 300);
            }
        }

        function clearAppCache() {
            const t = translations[currentLang];
            showConfirmationModal(
                t.clear_cache_title,
                t.clear_cache_confirm,
                () => {
                    // Clear cache logic here
                    // Show success message immediately
                    setTimeout(() => {
                        showSuccessMessage(t.cache_cleared);
                    }, 100);
                },
                'warning'
            );
        }

        function factoryReset() {
            const t = translations[currentLang];
            showConfirmationModal(
                t.factory_reset_title,
                t.factory_reset_confirm,
                () => {
                    // Show success message immediately
                    setTimeout(() => {
                        showSuccessMessage(t.reset_complete);

                        // Clear ALL localStorage data and reload after showing message
                        setTimeout(() => {
                            localStorage.clear();
                            window.location.reload();
                        }, 1500);
                    }, 100);
                },
                'danger'
            );
        }

        function showSuccessMessage(message) {
            const t = translations[currentLang];
            const modal = document.getElementById('confirmationModal');
            const header = document.getElementById('confirmModalHeader');
            const icon = document.getElementById('confirmModalIcon');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const cancelBtn = document.getElementById('confirmModalCancelBtn'); // Get the actual cancel button element

            // Set success style
            header.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            icon.className = 'fas fa-check-circle';
            titleEl.textContent = currentLang === 'ar' ? 'نجح!' : currentLang === 'fr' ? 'Succès!' : 'Success!';
            messageEl.textContent = message;

            // Hide cancel button, show only OK
            cancelBtn.style.display = 'none';
            confirmBtn.style.flex = '1';
            confirmBtn.style.background = '#10b981';
            confirmBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
            confirmBtn.querySelector('span').textContent = currentLang === 'ar' ? 'حسناً' : 'OK';
            confirmBtn.onclick = closeConfirmationModal; // Set OK button to just close the modal

            // Show modal
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }


        function openAIModal() {
            const modal = document.getElementById('aiModal');
            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeAIModal() {
            const modal = document.getElementById('aiModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
    </script>

    <!-- Auth Modal -->
    <div id="authModal" class="dev-modal-overlay" onclick="if(event.target === this) closeAuthModal()">
        <div class="dev-modal"
            style="max-width: 400px; padding: 0; overflow: hidden; border-radius: 24px; text-align: center;">
            <button onclick="closeAuthModal()" class="btn icon-btn"
                style="position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; color: white; z-index: 10;"><i
                    class="fas fa-times"></i></button>

            <!-- Gradient Header - Uses Theme Colors -->
            <div
                style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); padding: 50px 30px; position: relative;">
                <div
                    style="width: 70px; height: 70px; background: rgba(255, 255, 255, 0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; backdrop-filter: blur(10px);">
                    <i class="fas fa-user-lock" style="font-size: 28px; color: white;"></i>
                </div>
                <h3 id="authTitle" style="font-weight: 800; font-size: 22px; color: white; margin: 0;">Login</h3>
            </div>

            <!-- Form Content -->
            <div style="padding: 40px 30px; background: var(--surface);">
                <div id="nameField" style="margin-bottom: 24px; display: none;">
                    <label
                        style="display: block; text-align: start; font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text-muted);"
                        data-key="name_label">Full Name</label>
                    <input type="text"
                        style="width: 100%; background: var(--bg); border: 1px solid var(--border-color); color: var(--text); padding: 14px 16px; font-size: 15px; font-weight: 500; border-radius: 12px; outline: none; transition: all 0.3s;"
                        placeholder="John Doe"
                        onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px var(--primary-soft)'"
                        onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                </div>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; text-align: start; font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text-muted);"
                        data-key="email_label">Email Address</label>
                    <input type="email"
                        style="width: 100%; background: var(--bg); border: 1px solid var(--border-color); color: var(--text); padding: 14px 16px; font-size: 15px; font-weight: 500; border-radius: 12px; outline: none; transition: all 0.3s;"
                        placeholder="example@mail.com"
                        onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px var(--primary-soft)'"
                        onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                </div>

                <div style="margin-bottom: 32px;">
                    <label
                        style="display: block; text-align: start; font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text-muted);"
                        data-key="password_label">Password</label>
                    <input type="password"
                        style="width: 100%; background: var(--bg); border: 1px solid var(--border-color); color: var(--text); padding: 14px 16px; font-size: 15px; font-weight: 500; border-radius: 12px; outline: none; transition: all 0.3s;"
                        placeholder="••••••••"
                        onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px var(--primary-soft)'"
                        onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                </div>

                <button id="authSubmitBtn"
                    style="width: 100%; background: var(--primary); color: white; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; border: none; cursor: pointer; box-shadow: 0 8px 16px var(--primary-soft); margin-bottom: 20px; transition: all 0.3s;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 24px var(--primary-soft)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px var(--primary-soft)'">Login</button>

                <div id="authToggleBtn" onclick="toggleAuthMode()"
                    style="font-size: 14px; color: var(--accent); font-weight: 600; cursor: pointer;">Don't have an
                    account?
                    Sign Up</div>
            </div>
        </div>
    </div>

    <!-- Welcome/Profile Modal -->
    <div id="welcomeModal" class="dev-modal-overlay" onclick="if(event.target === this) closeWelcomeModal()">
        <div class="dev-modal" style="max-width: 400px; width: 95%; padding: 0; overflow: hidden;">
            <div
                style="padding: 30px 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; text-align: center;">
                <div
                    style="width: 80px; height: 80px; border-radius: 50%; background: white; margin: 0 auto 15px auto; padding: 3px;">
                    <img id="welcomeModalImg"
                        src="https://ui-avatars.com/api/?name=User&background=8b5cf6&color=fff&size=128"
                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <h3 id="welcomeModalName" style="margin: 0; font-weight: 800; font-size: 22px;">User</h3>
                <div
                    style="font-size: 13px; opacity: 0.9; margin-top: 5px; background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 12px; border-radius: 20px;">
                    <span data-key="premium_member">Premium Member</span> <i class="fas fa-star"
                        style="color: #fcd34d; font-size: 11px;"></i>
                </div>
                <button onclick="closeWelcomeModal()" class="btn icon-btn"
                    style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; color: white; background: rgba(255,255,255,0.2);"><i
                        class="fas fa-times"></i></button>
            </div>
            <div style="padding: 24px;">

                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px;" data-key="net_balance">
                        Net Balance</div>
                    <div id="modalNetBalance" style="font-size: 32px; font-weight: 800; color: var(--primary);"></div>
                </div>

                <div style="background: var(--bg); border-radius: 16px; padding: 16px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 13px; font-weight: 700;" data-key="budget_used">Budget Used</span>
                        <span id="modalBudgetPercent"
                            style="font-size: 13px; font-weight: 700; color: var(--primary);"></span>
                    </div>
                    <div
                        style="width: 100%; height: 8px; background: var(--surface); border-radius: 4px; overflow: hidden; border: 1px solid var(--border-color);">
                        <div id="modalProgressBar"
                            style="height: 100%; background: var(--primary); border-radius: 4px; width: 0%; transition: width 0.5s ease;">
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"
                            data-key="monthly_income">Monthly Income</div>
                        <div id="modalTotalIncome" style="font-weight: 700; font-size: 15px; color: #10b981;"></div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;"
                            data-key="total_expenses">Total Expenses</div>
                        <div id="modalTotalExpenses" style="font-weight: 700; font-size: 15px; color: #ef4444;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- AI Coming Soon Modal -->
    <div id="aiModal" class="dev-modal-overlay" onclick="if(event.target === this) closeAIModal()">
        <div class="dev-modal" style="text-align: center; max-width: 350px;">
            <div
                style="width: 80px; height: 80px; background: linear-gradient(135deg,#8b5cf6,#d946ef); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);">
                <i class="fas fa-robot" style="font-size: 35px; color: white;"></i>
            </div>
            <h3 id="aiModalTitle" style="font-weight: 800; font-size: 20px; margin-bottom: 10px;"></h3>
            <p id="aiModalDesc" style="color: var(--text-muted); line-height: 1.6; margin-bottom: 25px;"></p>
            <button id="aiModalBtn" onclick="closeAIModal()" class="splash-btn"
                style="width: 100%; justify-content: center;"></button>
        </div>
    </div>

    <!-- Smart Notifications Modal -->
    <div id="notificationsModal" class="dev-modal-overlay"
        onclick="if(event.target === this) closeNotificationsModal()">
        <div class="dev-modal"
            style="max-width: 450px; width: 95%; text-align: start; padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh;">
            <div
                style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--primary), var(--accent)); color: white;">
                <h3 id="notifModalTitle"
                    style="font-weight: 800; margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                </h3>
                <button onclick="closeNotificationsModal()" class="btn icon-btn"
                    style="width: 30px; height: 30px; color: white; background: rgba(255,255,255,0.2);"><i
                        class="fas fa-times"></i></button>
            </div>
            <div id="notificationsList" style="padding: 20px; overflow-y: auto; flex: 1;">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- Transaction Modal (Global) -->
    <div id="transactionModal" class="dev-modal-overlay" onclick="if(event.target === this) closeTransactionModal()">
        <div class="dev-modal" style="text-align: start;">
            <button onclick="closeTransactionModal()" class="btn icon-btn"
                style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;"><i
                    class="fas fa-times"></i></button>
            <h3 id="transactionModalTitle" style="font-weight: 800; margin-bottom: 20px;"></h3>

            <label id="lblTransactionAmount"
                style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">المبلغ</label>
            <div style="position: relative; margin-bottom: 16px;">
                <span id="lblTransactionCurrency"
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; font-weight: 700;">د.ج</span>
                <input type="number" id="transactionAmount" class="splash-btn"
                    style="background: var(--bg); color: var(--text); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none; font-weight: 700;"
                    placeholder="0">
            </div>

            <label id="lblTransactionNote"
                style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">ملاحظة</label>
            <textarea id="transactionNote" class="splash-btn"
                style="background: var(--bg); color: var(--text); padding: 12px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none; font-weight: 500; height: 80px; resize: none;"
                placeholder="أضف ملاحظة..."></textarea>

            <button id="btnTransactionConfirm" onclick="saveTransaction()" class="splash-btn"
                style="margin-top: 20px; width: 100%;">تأكيد
                العملية</button>
        </div>
    </div>

    <!-- Quick Expense Modal -->
    <div id="quickExpenseModal" class="dev-modal-overlay" onclick="if(event.target === this) closeQuickExpenseModal()">
        <div class="dev-modal" style="text-align: start;">
            <button onclick="closeQuickExpenseModal()" class="btn icon-btn"
                style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;"><i
                    class="fas fa-times"></i></button>
            <h3 id="quickExpenseTitle" style="font-weight: 800; margin-bottom: 20px;"></h3>

            <label id="quickExpenseCategoryLabel"
                style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;"></label>
            <div style="position: relative; margin-bottom: 16px;">
                <select id="quickExpenseCategory" class="splash-btn"
                    style="background: var(--bg); color: var(--text); padding: 12px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none; font-weight: 600; appearance: none;">
                    <!-- Populated by JS -->
                </select>
                <i class="fas fa-chevron-down"
                    style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;"></i>
            </div>

            <label id="quickExpenseAmountLabel"
                style="font-size: 12px; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;"></label>
            <div style="position: relative; margin-bottom: 16px;">
                <span id="quickExpenseCurrency"
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px; font-weight: 700;"></span>
                <input type="number" id="quickExpenseAmount" class="splash-btn"
                    style="background: var(--bg); color: var(--text); padding: 12px 12px 12px 35px; width: 100%; border: 1px solid var(--border-color); box-shadow: none; opacity: 1; animation: none; font-weight: 700;"
                    placeholder="0">
            </div>

            <button id="quickExpenseSaveBtn" onclick="saveQuickExpense()" class="splash-btn"
                style="margin-top: 20px; width: 100%;"></button>
        </div>
    </div>

    <!-- Smart Actions Menu -->
    <div id="smartActionsOverlay" class="smart-actions-overlay"
        onclick="if(event.target === this) toggleSmartActions()">
        <div class="smart-actions-menu">
            <div style="text-align: center; margin-bottom: 25px;">
                <div
                    style="width: 40px; height: 5px; background: var(--border-color); border-radius: 10px; margin: 0 auto 15px; opacity: 0.5;">
                </div>
                <h3 id="smartActionsTitle" style="margin: 0; font-weight: 800; font-size: 18px;"></h3>
            </div>

            <div class="action-grid">
                <!-- Add Expense (Quick) -->
                <div class="smart-action-item" onclick="toggleSmartActions(); openQuickExpenseModal()">
                    <div class="smart-action-icon" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="smart-action-label"></div>
                </div>

                <!-- Add Deposit -->
                <div class="smart-action-item" onclick="toggleSmartActions(); openTransactionModal('deposit')">
                    <div class="smart-action-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="smart-action-label"></div>
                </div>

                <!-- Attendance -->
                <div class="smart-action-item" onclick="toggleSmartActions(); renderView('attendance')">
                    <div class="smart-action-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="smart-action-label"></div>
                </div>

                <!-- AI Assistant -->
                <div class="smart-action-item" onclick="toggleSmartActions(); openAIModal()">
                    <div class="smart-action-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="smart-action-label"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Advanced Settings -->
    <!-- Profile Modal -->
    <div id="profileModal" class="dev-modal-overlay" onclick="if(event.target === this) closeProfileModal()"
        style="z-index: 2500;">
        <div class="dev-modal" style="max-width: 350px; padding: 0; overflow: hidden; text-align: center;">
            <div
                style="background: linear-gradient(135deg, var(--primary), var(--accent)); padding: 40px 20px 30px; position: relative;">
                <button onclick="closeProfileModal()" class="btn icon-btn"
                    style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; color: white; background: rgba(255,255,255,0.2);"><i
                        class="fas fa-times"></i></button>

                <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 15px;">
                    <div
                        style="width: 100%; height: 100%; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); overflow: hidden; background: white; display: flex; align-items: center; justify-content: center;">
                        <img id="profileImage" src="" alt="Profile"
                            style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <i id="profilePlaceholderIcon" class="fas fa-user"
                            style="font-size: 40px; color: var(--text-muted);"></i>
                    </div>
                    <label for="profileUpload"
                        style="position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; background: var(--text); color: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                        <i class="fas fa-camera" style="font-size: 14px;"></i>
                    </label>
                    <input type="file" id="profileUpload" accept="image/*" style="display: none;"
                        onchange="handleProfileImageUpload(this)">
                </div>

                <h3 id="profileName" style="color: white; margin: 0; font-weight: 800; font-size: 20px;"></h3>
                <div id="profileEmail" style="color: rgba(255,255,255,0.8); font-size: 13px; margin-top: 5px;"></div>
            </div>

            <div style="padding: 25px;">
                <div
                    style="text-align: center; padding: 20px 10px; margin-bottom: 15px; background: var(--bg); border-radius: 16px; border: 1px solid var(--border-color);">
                    <div
                        style="font-size: 28px; margin-bottom: 10px; animation: wave 2s infinite; display: inline-block;">
                        👋</div>
                    <div style="font-weight: 700; font-size: 16px; color: var(--text); margin-bottom: 5px;"
                        data-key="greeting_welcome">Welcome</div>
                    <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6;"
                        data-key="welcome_back_msg">We are glad to have you here!</div>
                </div>

                <button onclick="handleLogout()" class="btn"
                    style="width: 100%; padding: 15px; background: #fee2e2; color: #ef4444; border-radius: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-key="btn_logout">Logout</span>
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes wave {
            0% {
                transform: rotate(0deg);
            }

            10% {
                transform: rotate(14deg);
            }

            20% {
                transform: rotate(-8deg);
            }

            30% {
                transform: rotate(14deg);
            }

            40% {
                transform: rotate(-4deg);
            }

            50% {
                transform: rotate(10deg);
            }

            60% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>

    <div id="confirmationModal" class="dev-modal-overlay" style="z-index: 3000;">
        <div class="dev-modal" style="max-width: 400px; padding: 0; overflow: hidden; text-align: center;">
            <div id="confirmModalHeader"
                style="padding: 30px 20px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                <div
                    style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; backdrop-filter: blur(10px);">
                    <i id="confirmModalIcon" class="fas fa-exclamation-triangle"
                        style="font-size: 26px; color: white;"></i>
                </div>
                <h3 id="confirmModalTitle" style="font-weight: 800; font-size: 20px; margin: 0; color: white;"></h3>
            </div>

            <div style="padding: 30px 25px; background: var(--surface);">
                <p id="confirmModalMessage"
                    style="font-size: 15px; line-height: 1.7; color: var(--text); margin: 0 0 25px 0; white-space: pre-line;">
                </p>

                <div style="display: flex; gap: 12px;">
                    <button onclick="closeConfirmationModal()" class="btn"
                        style="flex: 1; padding: 14px; background: var(--bg); color: var(--text); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <span id="confirmModalCancelBtn"></span>
                    </button>
                    <button onclick="executeConfirmation()" id="confirmModalConfirmBtn" class="btn"
                        style="flex: 1; padding: 14px; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); transition: all 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'">
                        <span id="confirmModalConfirmBtnText"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSmartActions() {
            const overlay = document.getElementById('smartActionsOverlay');
            const fab = document.querySelector('.fab-btn i');

            if (overlay.classList.contains('open')) {
                overlay.classList.remove('open');
                fab.style.transform = 'rotate(0deg)';
            } else {
                overlay.style.display = 'flex';
                // Force reflow
                overlay.offsetHeight;
                overlay.classList.add('open');
                fab.style.transform = 'rotate(45deg)';
            }
        }

        // --- Quick Expense Logic ---
        function openQuickExpenseModal() {
            const modal = document.getElementById('quickExpenseModal');
            const select = document.getElementById('quickExpenseCategory');

            // Populate categories
            if (expenseManagerData && expenseManagerData.items) {
                select.innerHTML = expenseManagerData.items.map((item, index) =>
                    `<option value="${index}">${item.category}</option>`
                ).join('');
            } else {
                select.innerHTML = '<option disabled>لا توجد تصنيفات</option>';
            }

            document.getElementById('quickExpenseAmount').value = '';

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeQuickExpenseModal() {
            const modal = document.getElementById('quickExpenseModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function saveQuickExpense() {
            const index = document.getElementById('quickExpenseCategory').value;
            const amount = Number(document.getElementById('quickExpenseAmount').value);

            if (index === null || isNaN(amount) || amount <= 0) return;

            // Update Expense Data
            const item = expenseManagerData.items[index];
            const oldValue = item.actual;
            item.actual += amount;

            // Log Activity
            const cur = currencies[currentCurrency];
            const details = `${item.category}: <span dir="ltr" style="color: #ef4444; font-weight:700;">+${amount} ${cur.symbol}</span> (سريع)`;
            logActivity('log_expense_diff', details);

            saveExpenses();

            // Refresh view if currently on expenses
            if (currentView === 'expenses') {
                renderView('expenses');
            }

            closeQuickExpenseModal();
            updateNotificationBadge();
        }

        // --- Smart Notifications System ---
        let dismissedNotifications = JSON.parse(localStorage.getItem('dismissedNotifications')) || [];

        function generateSmartNotifications() {
            const notifications = [];
            const cur = currencies[currentCurrency];
            const t = translations[currentLang];
            const now = new Date();

            // 1. Budget Alerts
            const totalBudget = expenseManagerData.items.reduce((sum, item) => sum + item.budget, 0);
            const totalActual = expenseManagerData.items.reduce((sum, item) => sum + item.actual, 0);
            const budgetPercent = totalBudget > 0 ? (totalActual / totalBudget) * 100 : 0;

            if (budgetPercent > 90) {
                notifications.push({
                    id: 'budget-critical',
                    type: 'warning',
                    icon: 'fa-exclamation-triangle',
                    color: '#ef4444',
                    title: t.notif_budget_critical,
                    message: t.notif_budget_msg.replace('{percent}', budgetPercent.toFixed(1)),
                    time: t.time_now
                });
            } else if (budgetPercent > 70) {
                notifications.push({
                    id: 'budget-warning',
                    type: 'info',
                    icon: 'fa-info-circle',
                    color: '#f59e0b',
                    title: t.notif_budget_warning,
                    message: t.notif_budget_watch.replace('{percent}', budgetPercent.toFixed(1)),
                    time: t.time_now
                });
            }

            // 2. Wallet Balance Alerts
            if (smartWalletData.balance > 0) {
                if (smartWalletData.balance < 1000) {
                    notifications.push({
                        id: 'wallet-low',
                        type: 'info',
                        icon: 'fa-wallet',
                        color: '#8b5cf6',
                        title: t.notif_wallet_low,
                        message: t.notif_wallet_low_msg.replace('{balance}', `${cur.symbol} ${smartWalletData.balance}`),
                        time: t.time_now
                    });
                } else if (smartWalletData.balance > 10000) {
                    notifications.push({
                        id: 'wallet-high',
                        type: 'success',
                        icon: 'fa-trophy',
                        color: '#10b981',
                        title: t.notif_wallet_high,
                        message: t.notif_wallet_high_msg.replace('{balance}', `${cur.symbol} ${smartWalletData.balance}`),
                        time: t.time_now
                    });
                }
            }

            // 3. Attendance Alerts
            const year = now.getFullYear();
            const month = now.getMonth();
            let presentCount = 0;
            let absentCount = 0;

            Object.keys(attendanceData.records).forEach(dateStr => {
                const d = new Date(dateStr);
                if (d.getFullYear() === year && d.getMonth() === month) {
                    if (attendanceData.records[dateStr] === 'present') presentCount++;
                    if (attendanceData.records[dateStr] === 'absent') absentCount++;
                }
            });

            if (absentCount > 3) {
                notifications.push({
                    id: 'attendance-absent',
                    type: 'warning',
                    icon: 'fa-calendar-xmark',
                    color: '#ef4444',
                    title: t.notif_attendance_absent,
                    message: t.notif_absent_msg.replace('{count}', absentCount),
                    time: t.time_now
                });
            } else if (presentCount > 20) {
                notifications.push({
                    id: 'attendance-present',
                    type: 'success',
                    icon: 'fa-calendar-check',
                    color: '#10b981',
                    title: t.notif_attendance_present,
                    message: t.notif_present_msg.replace('{count}', presentCount),
                    time: t.time_now
                });
            }

            // 4. Expense Categories Alerts
            expenseManagerData.items.forEach((item, index) => {
                const percent = item.budget > 0 ? (item.actual / item.budget) * 100 : 0;
                if (percent > 100) {
                    notifications.push({
                        id: `category-${index}`,
                        type: 'warning',
                        icon: 'fa-chart-line',
                        color: '#ef4444',
                        title: `${t.notif_category_exceed} "${item.category}"`,
                        message: t.notif_exceed_msg.replace('{percent}', (percent - 100).toFixed(1)),
                        time: t.time_now
                    });
                }
            });

            // 5. Motivational Messages
            if (notifications.length === 0) {
                notifications.push({
                    id: 'all-good',
                    type: 'success',
                    icon: 'fa-check-circle',
                    color: '#10b981',
                    title: t.notif_all_good,
                    message: t.notif_perfect_msg,
                    time: t.time_now
                });
            }

            // Filter out dismissed notifications
            return notifications.filter(n => !dismissedNotifications.includes(n.id));
        }

        function dismissNotification(notifId) {
            if (!dismissedNotifications.includes(notifId)) {
                dismissedNotifications.push(notifId);
                localStorage.setItem('dismissedNotifications', JSON.stringify(dismissedNotifications));
            }

            // Remove from UI
            const notifElement = document.querySelector(`[data-notif-id="${notifId}"]`);
            if (notifElement) {
                notifElement.style.transition = 'all 0.3s ease';
                notifElement.style.opacity = '0';
                notifElement.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    notifElement.remove();

                    // Check if no notifications left
                    const list = document.getElementById('notificationsList');
                    const t = translations[currentLang];
                    if (list.children.length === 0) {
                        list.innerHTML = `
                            <div class="empty-state-container">
                                <div class="empty-state-icon"><i class="fas fa-bell-slash"></i></div>
                                <div class="empty-state-text">${t.no_notifications}</div>
                            </div>
                        `;
                    }

                    updateNotificationBadge();
                }, 300);
            }
        }

        function openNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            const list = document.getElementById('notificationsList');
            const t = translations[currentLang];

            const notifications = generateSmartNotifications();

            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="empty-state-container">
                        <div class="empty-state-icon"><i class="fas fa-bell-slash"></i></div>
                        <div class="empty-state-text">${t.no_notifications}</div>
                    </div>
                `;
            } else {
                list.innerHTML = notifications.map(notif => `
                    <div data-notif-id="${notif.id}" style="background: ${notif.color}08; border-left: 4px solid ${notif.color}; padding: 16px; border-radius: 12px; margin-bottom: 12px; position: relative;">
                        <button onclick="dismissNotification('${notif.id}')" style="position: absolute; top: 12px; right: 12px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='${notif.color}15'; this.style.color='${notif.color}'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'">
                            <i class="fas fa-times"></i>
                        </button>
                        <div style="display: flex; gap: 14px; align-items: flex-start; padding-right: 20px;">
                            <div style="width: 40px; height: 40px; border-radius: 12px; background: ${notif.color}15; color: ${notif.color}; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                                <i class="fas ${notif.icon}"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 800; font-size: 15px; margin-bottom: 6px; color: var(--text);">${notif.title}</div>
                                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.6; margin-bottom: 8px;">${notif.message}</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">
                                    <i class="far fa-clock"></i> ${notif.time}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Hide badge when opening
            const badge = document.getElementById('notificationBadge');
            badge.style.display = 'none';

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeNotificationsModal() {
            const modal = document.getElementById('notificationsModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const notifications = generateSmartNotifications();
            const importantCount = notifications.filter(n => n.type === 'warning').length;

            if (importantCount > 0) {
                badge.textContent = importantCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Update badge on page load and data changes
        setTimeout(() => {
            updateNotificationBadge();
        }, 1000);

        // --- Firebase Auth Integration ---
        document.getElementById('authSubmitBtn').addEventListener('click', async () => {
            const email = document.querySelector('input[type="email"]').value;
            const password = document.querySelector('input[type="password"]').value;
            const nameInput = document.getElementById('nameField').querySelector('input');
            const name = nameInput ? nameInput.value : '';
            const btn = document.getElementById('authSubmitBtn');

            if (!email || !password) {
                alert('Please fill all fields');
                return;
            }

            // Show loading state
            const originalText = btn.innerText;
            btn.innerText = '...';
            btn.disabled = true;

            let result;
            if (isLoginMode) {
                result = await window.firebaseAuth.login(email, password);
            } else {
                if (!name) {
                    alert('Name is required');
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }
                result = await window.firebaseAuth.register(email, password, name);
            }

            if (result.success) {
                closeAuthModal();
                // Show success message
                const t = translations[currentLang];
                const msg = isLoginMode ? (t.login_success || 'Login Successful') : (t.signup_success || 'Account Created Successfully');
                showSuccessMessage(msg);
                // UI update will happen via onAuthStateChanged listener
            } else {
                let errorMsg = result.error;
                if (errorMsg.includes('auth/email-already-in-use')) errorMsg = 'Email already in use';
                if (errorMsg.includes('auth/wrong-password')) errorMsg = 'Invalid password';
                if (errorMsg.includes('auth/user-not-found')) errorMsg = 'User not found';
                if (errorMsg.includes('auth/weak-password')) errorMsg = 'Password should be at least 6 characters';
                alert(errorMsg);
            }

            btn.innerText = originalText;
            btn.disabled = false;
        });

        // --- Profile Modal Logic ---
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            const nameEl = document.getElementById('profileName');
            const emailEl = document.getElementById('profileEmail');
            const imgEl = document.getElementById('profileImage');
            const iconEl = document.getElementById('profilePlaceholderIcon');

            // Get user data
            const userName = localStorage.getItem('user_name') || 'User';
            const userEmail = localStorage.getItem('user_email') || 'user@example.com';
            const userPhoto = localStorage.getItem('user_photo');

            nameEl.textContent = userName;
            emailEl.textContent = userEmail;

            if (userPhoto) {
                imgEl.src = userPhoto;
                imgEl.style.display = 'block';
                iconEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                iconEl.style.display = 'block';
            }

            modal.style.display = 'flex';
            modal.offsetHeight;
            modal.classList.add('open');
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function handleProfileImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;
                    localStorage.setItem('user_photo', base64);

                    // Update Modal
                    document.getElementById('profileImage').src = base64;
                    document.getElementById('profileImage').style.display = 'block';
                    document.getElementById('profilePlaceholderIcon').style.display = 'none';

                    // Update Header Avatar
                    updateHeaderAvatar(base64);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateHeaderAvatar(src) {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                if (src) {
                    loginBtn.innerHTML = `<img id="headerAvatar" src="${src}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary);">`;
                } else {
                    // Fallback to initials or icon
                    const name = localStorage.getItem('user_name') || 'U';
                    const initial = name.charAt(0).toUpperCase();
                    loginBtn.innerHTML = `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-soft); color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px;">${initial}</div>`;
                }
            }
        }

        function handleLogout() {
            const t = translations[currentLang];
            showConfirmationModal(
                t.btn_logout,
                t.logout_confirm,
                async () => {
                    await window.firebaseAuth.logout();
                    closeProfileModal();
                },
                'danger'
            );
        }

        // --- Backup & Restore Logic ---
        async function handleBackup(event) {
            const t = translations[currentLang];

            // Check if logged in
            if (!localStorage.getItem('user_email')) {
                showConfirmationModal(
                    t.btn_backup,
                    t.login_required_backup,
                    () => {
                        openAuthModal();
                    },
                    'warning'
                );
                return;
            }

            // Gather Data - حفظ جميع البيانات بشكل صحيح
            const dataToBackup = {
                allExpensePeriods: allExpensePeriods, // حفظ جميع الفترات بدلاً من الفترة الحالية فقط
                expenseManagerData: expenseManagerData, // للتوافق مع الإصدارات القديمة
                smartWalletData: smartWalletData,
                attendanceData: attendanceData,
                settings: {
                    lang: currentLang,
                    theme: currentTheme,
                    currency: currentCurrency,
                    expense_distribution_mode: localStorage.getItem('expense_distribution_mode') || 'monthly'
                }
            };

            // Show loading (optional - update UI if element exists)
            const clickedElement = event ? event.currentTarget : null;
            let originalHTML = '';
            if (clickedElement) {
                originalHTML = clickedElement.innerHTML;
                clickedElement.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>';
                clickedElement.style.pointerEvents = 'none';
            }

            const result = await window.firebaseAuth.backupData(dataToBackup);

            // تتبع: طباعة البيانات المحفوظة
            console.log('📤 Backup Data:', dataToBackup);
            console.log('📤 allExpensePeriods:', allExpensePeriods);
            console.log('📤 Result:', result);

            if (result.success) {
                const date = new Date(result.timestamp).toLocaleString(currentLang);
                localStorage.setItem('last_backup_date', date);

                // Update UI
                const dateEl = document.getElementById('lastBackupDatePage');
                if (dateEl) dateEl.innerText = date;

                // Update data summary counts
                // حساب عدد جميع العناصر من جميع الفترات
                let totalExpenseItems = 0;
                Object.keys(allExpensePeriods).forEach(periodId => {
                    if (allExpensePeriods[periodId].items) {
                        totalExpenseItems += allExpensePeriods[periodId].items.length;
                    }
                });

                const walletCount = (smartWalletData && smartWalletData.transactions) ? smartWalletData.transactions.length : 0;
                const attendanceCount = (attendanceData && attendanceData.records) ? Object.keys(attendanceData.records).length : 0;

                const expenseEl = document.getElementById('cloudExpenseCount');
                const walletEl = document.getElementById('cloudWalletCount');
                const attendanceEl = document.getElementById('cloudAttendanceCount');

                if (expenseEl) expenseEl.textContent = totalExpenseItems;
                if (walletEl) walletEl.textContent = walletCount;
                if (attendanceEl) attendanceEl.textContent = attendanceCount;

                showSuccessMessage(t.backup_success);
            } else {
                // Show error in professional modal
                showConfirmationModal(
                    t.btn_backup,
                    'Backup failed: ' + result.error,
                    () => { },
                    'danger'
                );
            }

            // Restore element
            if (clickedElement) {
                clickedElement.innerHTML = originalHTML;
                clickedElement.style.pointerEvents = 'auto';
            }
        }

        async function handleRestore(event) {
            const t = translations[currentLang];

            // Check if logged in
            if (!localStorage.getItem('user_email')) {
                showConfirmationModal(
                    t.btn_restore,
                    t.login_required_backup,
                    () => {
                        openAuthModal();
                    },
                    'warning'
                );
                return;
            }

            showConfirmationModal(
                t.btn_restore,
                t.restore_confirm,
                async () => {
                    const result = await window.firebaseAuth.restoreData();

                    // تتبع: طباعة البيانات المسترجعة
                    console.log('📥 Restore Result:', result);
                    console.log('📥 Cloud Data:', result.data);

                    if (result.success) {
                        const cloudData = result.data;

                        // تتبع: طباعة التفاصيل
                        console.log('📥 cloudData.allExpensePeriods:', cloudData.allExpensePeriods);
                        console.log('📥 Local allExpensePeriods BEFORE:', JSON.parse(JSON.stringify(allExpensePeriods)));

                        // Merge Logic
                        // 1. Expenses: استبدال كامل لجميع الفترات
                        if (cloudData.allExpensePeriods) {
                            // استبدال كامل: حذف جميع الفترات المحلية واستبدالها بما في السحابة
                            allExpensePeriods = cloudData.allExpensePeriods;

                            console.log('✅ allExpensePeriods AFTER replace:', allExpensePeriods);

                            // حفظ جميع الفترات
                            localStorage.setItem('allExpensePeriods', JSON.stringify(allExpensePeriods));

                            // تحديد الفترة الحالية بناءً على ما في السحابة
                            const availablePeriods = Object.keys(allExpensePeriods);

                            if (availablePeriods.includes('PERMANENT')) {
                                // إذا كان هناك PERMANENT، استخدمه
                                currentPeriodId = 'PERMANENT';
                                console.log('✅ Switching to PERMANENT mode');
                            } else if (availablePeriods.length > 0) {
                                // استخدم أحدث فترة متاحة
                                currentPeriodId = availablePeriods.sort().reverse()[0];
                                console.log('✅ Using latest period:', currentPeriodId);
                            } else {
                                // لا توجد فترات، استخدم الشهر الحالي
                                currentPeriodId = getCurrentMonthId();
                                console.log('✅ No periods found, using current month:', currentPeriodId);
                            }

                            // تحديث البيانات الحالية
                            expenseManagerData = getPeriodData(currentPeriodId);

                            console.log('✅ expenseManagerData AFTER getPeriodData:', expenseManagerData);
                        } else if (cloudData.expenseManagerData) {
                            // للتوافق مع النسخ القديمة - استبدال كامل
                            expenseManagerData = cloudData.expenseManagerData;

                            // حذف جميع الفترات القديمة واستبدالها بالفترة الحالية فقط
                            allExpensePeriods = {};
                            allExpensePeriods[currentPeriodId] = expenseManagerData;
                            localStorage.setItem('allExpensePeriods', JSON.stringify(allExpensePeriods));

                            console.log('✅ Using old format - expenseManagerData:', expenseManagerData);
                        } else {
                            console.warn('⚠️ No expense data in cloud!');
                        }

                        // تحديث وضع التوزيع من الإعدادات المسترجعة
                        if (cloudData.settings && cloudData.settings.expense_distribution_mode) {
                            localStorage.setItem('expense_distribution_mode', cloudData.settings.expense_distribution_mode);
                            console.log('✅ Updated expense_distribution_mode:', cloudData.settings.expense_distribution_mode);
                        }

                        // 2. Wallet: استبدال كامل
                        if (cloudData.smartWalletData) {
                            smartWalletData = cloudData.smartWalletData;
                        }

                        // 3. Attendance: استبدال كامل
                        if (cloudData.attendanceData) {
                            attendanceData = cloudData.attendanceData;
                        }

                        // 4. Settings: استرجاع جميع الإعدادات
                        if (cloudData.settings) {
                            if (cloudData.settings.lang) {
                                currentLang = cloudData.settings.lang;
                                localStorage.setItem('selectedLanguage', currentLang);
                                console.log('✅ Updated language:', currentLang);
                            }
                            if (cloudData.settings.theme) {
                                currentTheme = cloudData.settings.theme;
                                localStorage.setItem('selectedTheme', currentTheme);
                                console.log('✅ Updated theme:', currentTheme);
                            }
                            if (cloudData.settings.currency) {
                                currentCurrency = cloudData.settings.currency;
                                localStorage.setItem('selectedCurrency', currentCurrency);
                                console.log('✅ Updated currency:', currentCurrency);
                            }
                        }

                        // Save merged data
                        saveExpenses();
                        localStorage.setItem('smartWalletData', JSON.stringify(smartWalletData));
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));

                        // Update Last Backup Date
                        const date = new Date(result.timestamp).toLocaleString(currentLang);
                        localStorage.setItem('last_backup_date', date);
                        const dateEl = document.getElementById('lastBackupDatePage');
                        if (dateEl) dateEl.innerText = date;

                        showSuccessMessage(t.restore_success);

                        // Refresh View
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);

                    } else {
                        // Show error in professional modal
                        showConfirmationModal(
                            t.btn_restore,
                            t.no_backup_found,
                            () => { },
                            'warning'
                        );
                    }
                },
                'warning'
            );
        }

        // Listen for Auth State Changes
        window.addEventListener('firebase-ready', () => {
            window.firebaseAuth.initListener((user) => {
                const loginBtn = document.getElementById('loginBtn');

                if (user) {
                    // User is logged in
                    if (loginBtn) {
                        // Change login button to Profile Avatar
                        const userPhoto = localStorage.getItem('user_photo');
                        updateHeaderAvatar(userPhoto);

                        loginBtn.onclick = openProfileModal;
                    }

                    // Save user info for display
                    const displayName = user.displayName || user.email.split('@')[0];
                    localStorage.setItem('user_name', displayName);
                    localStorage.setItem('user_email', user.email);

                    // Update greeting immediately if on home view
                    if (currentView === 'home') {
                        const greetingEl = document.getElementById('greeting');
                        const t = translations[currentLang];
                        if (greetingEl) greetingEl.innerText = t.greeting_welcome + "، " + displayName + " 👋";
                    }

                } else {
                    // User is logged out
                    if (loginBtn) {
                        loginBtn.innerHTML = '<i class="fas fa-user-circle"></i>';
                        loginBtn.onclick = openAuthModal;
                    }
                    localStorage.removeItem('user_name');
                    localStorage.removeItem('user_email');
                    // Keep photo in local storage or remove? Maybe keep for cache but don't show

                    // Update greeting to default
                    if (currentView === 'home') {
                        const greetingEl = document.getElementById('greeting');
                        const t = translations[currentLang];
                        if (greetingEl) greetingEl.innerText = t.greeting_welcome + " 👋";
                    }
                }
            });
        });
    </script>
</body>

</html>
